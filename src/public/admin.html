<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin — Review Queue</title>
  <link rel="icon" type="image/svg+xml" href="/icon.svg">
  <!-- Material Design Icons and Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
  <!-- Material Components Web -->
  <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
  <!-- Custom styles -->
  <link rel="stylesheet" href="/styles.css">
  <style>
    .admin-container { max-width: 1200px; margin: 0 auto; }
    .login { max-width: 320px; margin: 4rem auto; padding: 2rem; }
    .login input { width: 100%; padding: 0.5rem; margin-bottom: 0.75rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
    .login button { padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; background: #1976d2; color: white; border: none; border-radius: 4px; }
    .error { color: #c00; margin-top: 0.5rem; }
    .queue { margin-top: 2rem; }
    .queue-item { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white; }
    .queue-item h3 { margin: 0 0 0.5rem; font-size: 1rem; }
    .queue-item a { color: #1976d2; text-decoration: none; }
    .queue-item a:hover { text-decoration: underline; }
    .queue-item .reason { color: #666; margin: 0.5rem 0; font-size: 0.9rem; }
    .queue-item .meta { font-size: 0.85rem; color: #888; }
    .queue-item .actions { margin-top: 0.75rem; }
    .queue-item button { margin-right: 0.5rem; padding: 0.4rem 0.8rem; cursor: pointer; }
    .queue-item button.approve { background: #0a0; color: #fff; border: none; border-radius: 4px; }
    .queue-item button.reject { background: #c00; color: #fff; border: none; border-radius: 4px; }
    .queue-item .badge { display: inline-block; font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 4px; margin-left: 0.5rem; }
    .queue-item .badge.visible { background: #e0f2e0; color: #0a0; }
    .queue-item .badge.flagged { background: #fff3e0; color: #c60; }
    .queue-item .badge.approved { background: #e0f2e0; color: #0a0; }
    .queue-item .badge.rejected { background: #ffe0e0; color: #c00; }
    .queue-intro { color: #666; font-size: 0.9rem; margin-bottom: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 4px; }
    .empty { color: #666; text-align: center; padding: 2rem; }
    .logout { margin-top: 1.5rem; text-align: right; }
    .logout button { padding: 0.4rem 0.8rem; cursor: pointer; background: #666; color: white; border: none; border-radius: 4px; }
    .content-area { padding: 1rem; }
    .content-area[hidden] { display: none !important; }
    .view-container { display: none; }
    .view-container.active { display: block; }
    .queue-item button.merge-btn { background: #1976d2; color: #fff; border: none; border-radius: 4px; }
    .queue-item button.distinguish { background: #666; color: #fff; border: none; border-radius: 4px; }
    .merge-pair-header { font-weight: 600; margin-bottom: 0.5rem; }
    .merge-pair-reform { font-size: 0.9rem; color: #444; margin-bottom: 0.25rem; }
    .merge-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .merge-modal-overlay.open { display: flex; }
    .merge-modal { background: white; border-radius: 8px; max-width: 640px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 1.5rem; }
    .merge-modal h3 { margin: 0 0 1rem; font-size: 1.1rem; }
    .merge-form label { display: block; margin-top: 0.75rem; font-weight: 500; font-size: 0.9rem; }
    .merge-form input[type="text"], .merge-form textarea, .merge-form select { width: 100%; padding: 0.4rem; margin-top: 0.25rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
    .merge-form textarea { min-height: 60px; }
    .merge-form .keep-choice { margin: 0.75rem 0; }
    .merge-form .keep-choice label { display: inline; margin-right: 1rem; font-weight: normal; }
    .merge-form-actions { margin-top: 1.5rem; display: flex; gap: 0.5rem; }
    .merge-form-actions button { padding: 0.5rem 1rem; cursor: pointer; border: none; border-radius: 4px; }
    .merge-form-actions button.save-merge { background: #0a0; color: #fff; }
    .merge-form-actions button.cancel-merge { background: #666; color: #fff; }
    .logs-filters { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .logs-filters select, .logs-filters input { padding: 0.4rem; font-size: 0.9rem; border: 1px solid #ccc; border-radius: 4px; }
    .logs-filters button { padding: 0.4rem 0.8rem; cursor: pointer; background: #1976d2; color: white; border: none; border-radius: 4px; }
    .logs-list { margin-top: 1rem; }
    .log-item { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; background: white; }
    .log-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .log-item-title { font-weight: 600; font-size: 1rem; }
    .log-item-meta { font-size: 0.85rem; color: #666; }
    .log-item-metadata { margin-top: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px; font-size: 0.85rem; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
    .log-item-error { color: #c00; margin-top: 0.5rem; font-size: 0.9rem; }
    .logs-pagination { margin-top: 1rem; display: flex; gap: 0.5rem; align-items: center; justify-content: center; }
    .logs-pagination button { padding: 0.4rem 0.8rem; cursor: pointer; background: #666; color: white; border: none; border-radius: 4px; }
    .logs-pagination button:disabled { background: #ccc; cursor: not-allowed; }
    .logs-pagination span { font-size: 0.9rem; color: #666; }
  </style>
</head>
<body>
  <div class="admin-container">
    <header>
      <div class="header-icon-wrapper">
        <img src="icon.svg" alt="" class="header-icon" aria-hidden="true">
      </div>
      <img src="banner.svg" alt="The Abundant City Policy Atlas - Changing Cities By Design" class="banner-img">
      <!-- Hidden text for accessibility -->
      <div class="sr-only">
        <h1>The Abundant City Policy Atlas - Admin</h1>
        <p>Review Queue</p>
      </div>
    </header>

    <div id="login" class="login">
      <form id="loginForm">
        <input type="password" name="password" placeholder="Password" required autocomplete="current-password">
        <button type="submit">Log in</button>
      </form>
      <div id="loginError" class="error" hidden></div>
      <p id="loading" style="margin-top:0.75rem;color:#666;" hidden>Checking…</p>
    </div>

    <div id="app" class="content-area" hidden>
      <!-- View Tabs -->
      <div class="mdc-tab-bar" role="tablist">
        <div class="mdc-tab-scroller">
          <div class="mdc-tab-scroller__scroll-area">
            <div class="mdc-tab-scroller__scroll-content">
              <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true" tabindex="0" id="heldTab">
                <span class="mdc-tab__content">
                  <span class="mdc-tab__icon material-icons" aria-hidden="true">pending</span>
                  <span class="mdc-tab__text-label">Held for Review</span>
                </span>
                <span class="mdc-tab-indicator mdc-tab-indicator--active">
                  <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                </span>
                <span class="mdc-tab__ripple"></span>
              </button>
              <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" id="acceptedTab">
                <span class="mdc-tab__content">
                  <span class="mdc-tab__icon material-icons" aria-hidden="true">check_circle</span>
                  <span class="mdc-tab__text-label">Accepted</span>
                </span>
                <span class="mdc-tab-indicator">
                  <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                </span>
                <span class="mdc-tab__ripple"></span>
              </button>
              <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" id="completedTab">
                <span class="mdc-tab__content">
                  <span class="mdc-tab__icon material-icons" aria-hidden="true">done_all</span>
                  <span class="mdc-tab__text-label">Completed</span>
                </span>
                <span class="mdc-tab-indicator">
                  <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                </span>
                <span class="mdc-tab__ripple"></span>
              </button>
              <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" id="mergeTab">
                <span class="mdc-tab__content">
                  <span class="mdc-tab__icon material-icons" aria-hidden="true">merge_type</span>
                  <span class="mdc-tab__text-label">Merge</span>
                </span>
                <span class="mdc-tab-indicator">
                  <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                </span>
                <span class="mdc-tab__ripple"></span>
              </button>
              <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" id="logsTab">
                <span class="mdc-tab__content">
                  <span class="mdc-tab__icon material-icons" aria-hidden="true">list_alt</span>
                  <span class="mdc-tab__text-label">Logs</span>
                </span>
                <span class="mdc-tab-indicator">
                  <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                </span>
                <span class="mdc-tab__ripple"></span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Held View -->
      <div id="heldView" class="view-container active">
        <p class="queue-intro">
          <strong>Reject</strong> → moves to completed queue, reform (if any) is hidden from users and never shown.<br>
          <strong>Accept</strong> → moves to completed queue, reform is shown to users (or created from flagged submission).
        </p>
        <div id="heldQueue" class="queue"></div>
        <div id="heldEmpty" class="empty" hidden>No items held for review.</div>
      </div>

      <!-- Accepted View -->
      <div id="acceptedView" class="view-container">
        <p class="queue-intro">
          These submissions have been accepted and are pending final review.
        </p>
        <div id="acceptedQueue" class="queue"></div>
        <div id="acceptedEmpty" class="empty" hidden>No accepted items.</div>
      </div>

      <!-- Completed View -->
      <div id="completedView" class="view-container">
        <p class="queue-intro">
          These submissions have been fully reviewed and processed.
        </p>
        <div id="completedQueue" class="queue"></div>
        <div id="completedEmpty" class="empty" hidden>No completed items.</div>
      </div>

      <!-- Merge View -->
      <div id="mergeView" class="view-container">
        <p class="queue-intro">
          Suspected duplicates (same place, same day). <strong>Distinguish</strong> → mark as distinct. <strong>Merge</strong> → combine two reforms into one.
        </p>
        <div id="mergeQueue" class="queue"></div>
        <div id="mergeEmpty" class="empty" hidden>No suspected duplicate pairs.</div>
      </div>

      <!-- Logs View -->
      <div id="logsView" class="view-container">
        <div class="logs-filters">
          <select id="logTypeFilter">
            <option value="">All Types</option>
            <option value="ingestion">Ingestion</option>
            <option value="bill_scraping">Bill Scraping</option>
            <option value="ai_enrichment">AI Enrichment</option>
            <option value="bill_submission">Bill Submission</option>
            <option value="admin_action">Admin Action</option>
          </select>
          <select id="statusFilter">
            <option value="">All Statuses</option>
            <option value="success">Success</option>
            <option value="failed">Failed</option>
            <option value="running">Running</option>
            <option value="partial">Partial</option>
          </select>
          <input type="text" id="actionFilter" placeholder="Filter by action...">
          <button type="button" id="refreshLogsBtn">Refresh</button>
        </div>
        <div id="logsList" class="logs-list"></div>
        <div id="logsEmpty" class="empty" hidden>No logs found.</div>
        <div id="logsPagination" class="logs-pagination"></div>
      </div>

      <div class="logout">
        <button type="button" id="logoutBtn">Log out</button>
      </div>
    </div>
  </div>

  <div id="mergeModalOverlay" class="merge-modal-overlay" aria-hidden="true">
    <div class="merge-modal" role="dialog" aria-labelledby="mergeModalTitle">
      <h3 id="mergeModalTitle">Merge reforms</h3>
      <form id="mergeForm" class="merge-form" onsubmit="return false;">
        <div class="keep-choice">
          <span>Keep reform:</span>
          <label><input type="radio" name="keep" value="a"> <span id="keepLabelA">A</span></label>
          <label><input type="radio" name="keep" value="b"> <span id="keepLabelB">B</span></label>
        </div>
        <label>Summary <textarea name="summary" rows="3"></textarea></label>
        <label>Notes <textarea name="notes" rows="2"></textarea></label>
        <label>Scope (comma‑separated) <input type="text" name="scope" placeholder="e.g. citywide"></label>
        <label>Land use (comma‑separated) <input type="text" name="land_use" placeholder="e.g. all uses"></label>
        <label>Requirements (comma‑separated) <input type="text" name="requirements" placeholder="e.g. by right"></label>
        <label>Status <select name="status"><option value="">—</option><option value="adopted">adopted</option><option value="proposed">proposed</option></select></label>
        <label>Intensity <select name="intensity"><option value="">—</option><option value="complete">complete</option><option value="partial">partial</option></select></label>
        <label>Reform mechanism <input type="text" name="reform_mechanism"></label>
        <label>Reform phase <input type="text" name="reform_phase"></label>
        <label>Legislative number <input type="text" name="legislative_number"></label>
        <label>Link URL <input type="text" name="link_url" placeholder="https://"></label>
        <label>Policy document <select name="policy_document_id"><option value="">—</option></select></label>
        <label>Reform types <div id="mergeReformTypesCheckboxes"></div></label>
        <div class="merge-form-actions">
          <button type="button" class="save-merge">Save merge</button>
          <button type="button" class="cancel-merge">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const credentials = 'include';
    let currentView = 'held';
    let tabBar = null;

    function show(el, on) {
      if (!el) return;
      el.hidden = !on;
    }

    function showLogin(err) {
      show(document.getElementById('login'), true);
      show(document.getElementById('app'), false);
      show(document.getElementById('loading'), false);
      const errEl = document.getElementById('loginError');
      if (err) {
        errEl.textContent = err;
        show(errEl, true);
      } else {
        show(errEl, false);
      }
    }

    function showApp() {
      show(document.getElementById('login'), false);
      show(document.getElementById('app'), true);
      initializeTabs();
    }

    function initializeTabs() {
      if (tabBar) return;
      const tabBarEl = document.querySelector('.mdc-tab-bar');
      tabBar = new mdc.tabBar.MDCTabBar(tabBarEl);
      
      tabBar.listen('MDCTabBar:activated', (event) => {
        const index = event.detail.index;
        const views = ['held', 'accepted', 'completed', 'merge', 'logs'];
        if (index >= 0 && index < views.length) {
          switchView(views[index]);
        } else {
          console.error(`Invalid tab index: ${index}, views array length: ${views.length}`);
        }
      });
    }

    function switchView(view) {
      currentView = view;
      const viewId = view + 'View';
      console.log(`Switching to view: ${view}, looking for element: ${viewId}`);
      
      // Remove active class from all views
      document.querySelectorAll('.view-container').forEach(el => {
        if (el) el.classList.remove('active');
      });
      
      // Find and activate the target view
      const viewElement = document.getElementById(viewId);
      if (!viewElement) {
        console.error(`View element not found: ${viewId}. Available views:`, 
          Array.from(document.querySelectorAll('.view-container')).map(el => el.id));
        return;
      }
      
      viewElement.classList.add('active');
      console.log(`Activated view: ${viewId}`);
      
      // Load data for the view
      if (view === 'merge') {
        loadMergeCandidates();
      } else if (view === 'logs') {
        loadLogs();
      } else {
        loadQueue(view);
      }
    }

    async function checkAuth() {
      const loading = document.getElementById('loading');
      show(loading, true);
      const r = await fetch('/api/get-review-queue?status=pending', { credentials });
      show(loading, false);
      if (r.ok) {
        showApp();
        return true;
      }
      if (r.status === 401) {
        showLogin();
        return false;
      }
      showLogin('Request failed');
      return false;
    }

    async function loadQueue(view) {
      let status;
      if (view === 'held') status = 'pending';
      else if (view === 'accepted') status = 'approved';
      else if (view === 'completed') status = 'completed';
      else return;

      const r = await fetch(`/api/get-review-queue?status=${status}`, { credentials });
      if (r.status === 401) {
        showLogin();
        return;
      }
      if (!r.ok) {
        const container = document.getElementById(view + 'Queue');
        container.innerHTML = '<p class="error">Failed to load queue.</p>';
        return;
      }
      const data = await r.json();
      const items = data.items || [];
      const container = document.getElementById(view + 'Queue');
      const emptyEl = document.getElementById(view + 'Empty');
      
      if (items.length === 0) {
        container.innerHTML = '';
        show(emptyEl, true);
        return;
      }
      show(emptyEl, false);
      
      container.innerHTML = items.map((item) => {
        const sub = (item.submitted_url || '').replace(/"/g, '&quot;');
        const reason = (item.reason || '—').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const prob = item.assessment?.probability != null ? (item.assessment.probability * 100).toFixed(0) + '%' : '—';
        const submitted = item.submitted_at || '—';
        const reviewed = item.reviewed_at || '—';
        const href = sub || '#';
        const visible = !!item.submission_reform_id;
        
        let badge = '';
        if (view === 'held') {
          badge = visible
            ? '<span class="badge visible">Visible while pending</span>'
            : '<span class="badge flagged">Flagged; hidden until accepted</span>';
        } else if (view === 'accepted') {
          badge = '<span class="badge approved">Approved</span>';
        } else if (view === 'completed') {
          const decision = item.review_decision;
          if (decision === 'approved') {
            badge = '<span class="badge approved">Approved</span>';
          } else if (decision === 'rejected') {
            badge = '<span class="badge rejected">Rejected</span>';
          }
        }

        let actions = '';
        if (view === 'held') {
          actions = `
            <div class="actions">
              <button type="button" class="approve" data-id="${item.id}">Accept</button>
              <button type="button" class="reject" data-id="${item.id}">Reject</button>
            </div>
          `;
        }

        let metaInfo = view === 'held' 
          ? `Submitted ${submitted} · Score ${prob}`
          : `Submitted ${submitted} · Reviewed ${reviewed}`;

        return (
          '<div class="queue-item" data-id="' + item.id + '">' +
          '<h3><a href="' + href + '" target="_blank" rel="noopener">' + (sub || 'No URL') + '</a>' + badge + '</h3>' +
          '<div class="meta">' + metaInfo + '</div>' +
          '<div class="reason">' + reason + '</div>' +
          actions +
          '</div>'
        );
      }).join('');

      if (view === 'held') {
        container.querySelectorAll('button.approve, button.reject').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const id = Number(btn.dataset.id);
            const decision = btn.classList.contains('approve') ? 'approved' : 'rejected';
            const res = await fetch('/api/update-review-decision', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials,
              body: JSON.stringify({ queue_id: id, decision })
            });
            const body = await res.json();
            if (body.success) {
              const row = container.querySelector(`[data-id="${id}"]`);
              if (row) row.remove();
              if (container.children.length === 0) show(emptyEl, true);
            }
          });
        });
      }
    }

    let mergePairs = [];
    let allReformTypes = [];

    async function loadMergeCandidates() {
      const container = document.getElementById('mergeQueue');
      const emptyEl = document.getElementById('mergeEmpty');
      const r = await fetch('/api/get-merge-candidates', { credentials });
      if (r.status === 401) { showLogin(); return; }
      if (!r.ok) {
        container.innerHTML = '<p class="error">Failed to load merge candidates.</p>';
        show(emptyEl, false);
        return;
      }
      const data = await r.json();
      mergePairs = data.pairs || [];
      if (mergePairs.length === 0) {
        container.innerHTML = '';
        show(emptyEl, true);
        return;
      }
      show(emptyEl, false);
      container.innerHTML = mergePairs.map((p, idx) => {
        const place = p.place || {};
        const loc = [place.place_name, place.state_name].filter(Boolean).join(', ');
        const date = p.adoption_date || '—';
        const a = p.reform_a || {};
        const b = p.reform_b || {};
        const sumA = (a.summary || '').slice(0, 120) + ((a.summary || '').length > 120 ? '…' : '');
        const sumB = (b.summary || '').slice(0, 120) + ((b.summary || '').length > 120 ? '…' : '');
        const typesA = (a.reform_types || []).map((t) => t.name).join(', ') || '—';
        const typesB = (b.reform_types || []).map((t) => t.name).join(', ') || '—';
        const key = `${p.reform_id_1}-${p.reform_id_2}`;
        return (
          '<div class="queue-item" data-pair-key="' + key + '">' +
          '<div class="merge-pair-header">' + (loc || '—') + ' · ' + date + '</div>' +
          '<div class="merge-pair-reform"><strong>A</strong> (id ' + a.id + '): ' + (sumA || '—') + ' | ' + typesA + '</div>' +
          '<div class="merge-pair-reform"><strong>B</strong> (id ' + b.id + '): ' + (sumB || '—') + ' | ' + typesB + '</div>' +
          '<div class="actions">' +
          '<button type="button" class="distinguish" data-id1="' + p.reform_id_1 + '" data-id2="' + p.reform_id_2 + '">Distinguish</button>' +
          '<button type="button" class="merge-btn" data-pair-index="' + idx + '">Merge</button>' +
          '</div></div>'
        );
      }).join('');

      container.querySelectorAll('button.distinguish').forEach((btn) => {
        btn.addEventListener('click', async () => {
          if (!confirm('Mark this pair as distinct? They will no longer appear as merge candidates.')) return;
          const id1 = Number(btn.dataset.id1);
          const id2 = Number(btn.dataset.id2);
          const res = await fetch('/api/distinguish-reforms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials,
            body: JSON.stringify({ reform_id_1: id1, reform_id_2: id2 })
          });
          const body = await res.json();
          if (body.success) loadMergeCandidates();
        });
      });

      container.querySelectorAll('button.merge-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.pairIndex, 10);
          openMergeModal(mergePairs[idx]);
        });
      });
    }

    function getKeptAndOther(pair) {
      const form = document.getElementById('mergeForm');
      const keepA = form.querySelector('input[name="keep"]:checked')?.value === 'a';
      const a = pair.reform_a;
      const b = pair.reform_b;
      return keepA ? { kept: a, other: b } : { kept: b, other: a };
    }

    function refillMergeFormFromKept(kept, other, pair) {
      const form = document.getElementById('mergeForm');
      form.querySelector('[name="summary"]').value = kept.summary || '';
      form.querySelector('[name="notes"]').value = kept.notes || '';
      form.querySelector('[name="scope"]').value = (kept.scope || []).join(', ');
      form.querySelector('[name="land_use"]').value = (kept.land_use || []).join(', ');
      form.querySelector('[name="requirements"]').value = (kept.requirements || []).join(', ');
      form.querySelector('[name="status"]').value = kept.status || '';
      form.querySelector('[name="intensity"]').value = kept.intensity || '';
      form.querySelector('[name="reform_mechanism"]').value = kept.reform_mechanism || '';
      form.querySelector('[name="reform_phase"]').value = kept.reform_phase || '';
      form.querySelector('[name="legislative_number"]').value = kept.legislative_number || '';
      form.querySelector('[name="link_url"]').value = kept.link_url || '';
      const pdSelect = form.querySelector('[name="policy_document_id"]');
      pdSelect.innerHTML = '<option value="">—</option>';
      const a = pair.reform_a;
      const b = pair.reform_b;
      const pds = [];
      if (a.policy_document_id) pds.push({ id: a.policy_document_id, label: 'A (id ' + a.id + '): ' + (a.policy_document?.reference_number || a.policy_document?.title || 'doc') });
      if (b.policy_document_id && b.policy_document_id !== a.policy_document_id) pds.push({ id: b.policy_document_id, label: 'B (id ' + b.id + '): ' + (b.policy_document?.reference_number || b.policy_document?.title || 'doc') });
      pds.forEach((pd) => { const o = document.createElement('option'); o.value = pd.id; o.textContent = pd.label; pdSelect.appendChild(o); });
      pdSelect.value = kept.policy_document_id || '';
      renderMergeReformTypes(kept, other);
    }

    function openMergeModal(pair) {
      const overlay = document.getElementById('mergeModalOverlay');
      const form = document.getElementById('mergeForm');
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden', 'false');
      window._mergePair = pair;
      const a = pair.reform_a;
      const b = pair.reform_b;
      document.getElementById('keepLabelA').textContent = 'A (id ' + a.id + ')';
      document.getElementById('keepLabelB').textContent = 'B (id ' + b.id + ')';
      const keepLower = (a.id < b.id);
      form.querySelector('input[name="keep"][value="' + (keepLower ? 'a' : 'b') + '"]').checked = true;
      const kept = keepLower ? a : b;
      const other = keepLower ? b : a;
      refillMergeFormFromKept(kept, other, pair);
    }

    async function renderMergeReformTypes(kept, other) {
      const box = document.getElementById('mergeReformTypesCheckboxes');
      if (allReformTypes.length === 0) {
        const r = await fetch('/api/get-reform-types');
        const d = await r.json();
        allReformTypes = d.reformTypes || [];
      }
      const keptIds = new Set((kept.reform_types || []).map((t) => t.id));
      const otherIds = new Set((other.reform_types || []).map((t) => t.id));
      const union = new Set([...keptIds, ...otherIds]);
      box.innerHTML = allReformTypes.map((rt) => {
        const checked = union.has(rt.id);
        return '<label style="display:block;font-weight:normal;margin:0.25rem 0"><input type="checkbox" name="reform_type_ids" value="' + rt.id + '"' + (checked ? ' checked' : '') + '> ' + (rt.name || rt.code) + '</label>';
      }).join('');
    }

    function closeMergeModal() {
      const overlay = document.getElementById('mergeModalOverlay');
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden', 'true');
      window._mergePair = null;
    }

    document.getElementById('mergeForm').querySelector('button.cancel-merge').addEventListener('click', closeMergeModal);
    document.getElementById('mergeModalOverlay').addEventListener('click', (e) => { if (e.target.id === 'mergeModalOverlay') closeMergeModal(); });

    document.getElementById('mergeForm').querySelectorAll('input[name="keep"]').forEach((radio) => {
      radio.addEventListener('change', () => {
        const pair = window._mergePair;
        if (!pair) return;
        const { kept, other } = getKeptAndOther(pair);
        refillMergeFormFromKept(kept, other, pair);
      });
    });

    document.getElementById('mergeForm').querySelector('button.save-merge').addEventListener('click', async () => {
      const pair = window._mergePair;
      if (!pair) return;
      const form = document.getElementById('mergeForm');
      const keepA = form.querySelector('input[name="keep"]:checked')?.value === 'a';
      const keepId = keepA ? pair.reform_a.id : pair.reform_b.id;
      const mergeId = keepA ? pair.reform_b.id : pair.reform_a.id;
      const scope = form.querySelector('[name="scope"]').value.trim().split(',').map((s) => s.trim()).filter(Boolean);
      const landUse = form.querySelector('[name="land_use"]').value.trim().split(',').map((s) => s.trim()).filter(Boolean);
      const req = form.querySelector('[name="requirements"]').value.trim().split(',').map((s) => s.trim()).filter(Boolean);
      const pdVal = form.querySelector('[name="policy_document_id"]').value;
      const policyDocId = pdVal === '' ? null : parseInt(pdVal, 10);
      const typeCheckboxes = form.querySelectorAll('input[name="reform_type_ids"]:checked');
      const reformTypeIds = Array.from(typeCheckboxes).map((cb) => parseInt(cb.value, 10)).filter((n) => !Number.isNaN(n));
      const updates = {
        summary: form.querySelector('[name="summary"]').value.trim() || null,
        notes: form.querySelector('[name="notes"]').value.trim() || null,
        scope,
        land_use: landUse,
        requirements: req,
        status: form.querySelector('[name="status"]').value || null,
        intensity: form.querySelector('[name="intensity"]').value || null,
        reform_mechanism: form.querySelector('[name="reform_mechanism"]').value.trim() || null,
        reform_phase: form.querySelector('[name="reform_phase"]').value.trim() || null,
        legislative_number: form.querySelector('[name="legislative_number"]').value.trim() || null,
        link_url: form.querySelector('[name="link_url"]').value.trim() || null,
        policy_document_id: policyDocId,
        reform_type_ids: reformTypeIds
      };
      const res = await fetch('/api/merge-reforms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials,
        body: JSON.stringify({ keep_reform_id: keepId, merge_reform_id: mergeId, updates })
      });
      const body = await res.json();
      if (body.success) { closeMergeModal(); loadMergeCandidates(); }
      else alert(body.error || 'Merge failed');
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const pw = form.password.value;
      const errEl = document.getElementById('loginError');
      show(errEl, false);
      const r = await fetch('/api/admin-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials,
        body: JSON.stringify({ password: pw })
      });
      const data = await r.json();
      if (data.success) {
        showApp();
        loadQueue('held');
      } else {
        errEl.textContent = data.error || 'Login failed';
        show(errEl, true);
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/admin-auth', { method: 'GET', credentials });
      showLogin();
    });

    // Logs functionality
    let currentLogsOffset = 0;
    let currentLogsLimit = 100;
    let currentLogsFilters = {};

    async function loadLogs() {
      const logType = document.getElementById('logTypeFilter').value;
      const status = document.getElementById('statusFilter').value;
      const action = document.getElementById('actionFilter').value;

      const params = new URLSearchParams();
      if (logType) params.append('log_type', logType);
      if (status) params.append('status', status);
      if (action) params.append('action', action);
      params.append('limit', currentLogsLimit);
      params.append('offset', currentLogsOffset);

      console.log('Loading logs with params:', params.toString());
      const r = await fetch(`/api/get-logs?${params.toString()}`, { credentials });
      console.log('Logs API response status:', r.status);
      if (r.status === 401) {
        showLogin();
        return;
      }
      if (!r.ok) {
        const container = document.getElementById('logsList');
        const errorText = await r.text();
        let errorData;
        try {
          errorData = JSON.parse(errorText);
        } catch {
          errorData = { error: errorText || 'Failed to load logs' };
        }
        container.innerHTML = `<p class="error">Failed to load logs: ${errorData.error || 'Unknown error'}</p>`;
        if (errorData.details) {
          container.innerHTML += `<p class="error" style="font-size: 0.8rem; margin-top: 0.5rem;">${errorData.details}</p>`;
        }
        show(emptyEl, false);
        return;
      }

      const data = await r.json();
      
      if (!data.success) {
        const container = document.getElementById('logsList');
        container.innerHTML = `<p class="error">Error: ${data.error || 'Unknown error'}</p>`;
        if (data.details) {
          container.innerHTML += `<p class="error" style="font-size: 0.8rem; margin-top: 0.5rem;">${data.details}</p>`;
        }
        show(emptyEl, false);
        return;
      }
      const logs = data.logs || [];
      const total = data.total || 0;
      console.log('Processing logs:', { logsCount: logs.length, total, logs });
      
      const container = document.getElementById('logsList');
      const emptyEl = document.getElementById('logsEmpty');
      const paginationEl = document.getElementById('logsPagination');

      if (logs.length === 0) {
        console.log('No logs to display, showing empty message');
        container.innerHTML = '';
        show(emptyEl, true);
        paginationEl.innerHTML = '';
        return;
      }

      console.log(`Rendering ${logs.length} logs`);

      show(emptyEl, false);

      try {
        container.innerHTML = logs.map(log => {
          console.log('Rendering log:', log);
          const date = log.created_at ? new Date(log.created_at).toLocaleString() : '—';
          const duration = log.duration_seconds ? `${log.duration_seconds}s` : '—';
          const metadata = log.metadata ? JSON.stringify(log.metadata, null, 2) : '';
          const error = log.error_message ? `<div class="log-item-error"><strong>Error:</strong> ${log.error_message.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>` : '';
          const statusBadge = log.status === 'success' ? '<span class="badge approved">Success</span>' :
                             log.status === 'failed' ? '<span class="badge rejected">Failed</span>' :
                             log.status === 'running' ? '<span class="badge visible">Running</span>' :
                             '<span class="badge flagged">Partial</span>';

          return (
            '<div class="log-item">' +
            '<div class="log-item-header">' +
            `<div><span class="log-item-title">${log.action || 'Unknown'}</span> ${statusBadge}</div>` +
            `<div class="log-item-meta">${date} · ${duration}</div>` +
            '</div>' +
            `<div class="log-item-meta">Type: ${log.log_type || 'Unknown'} | Action: ${log.action || 'Unknown'} | Status: ${log.status || 'Unknown'}</div>` +
            (metadata ? `<div class="log-item-metadata">${metadata.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>` : '') +
            error +
            '</div>'
          );
        }).join('');
        console.log('Logs rendered successfully');
      } catch (renderError) {
        console.error('Error rendering logs:', renderError);
        container.innerHTML = `<p class="error">Error rendering logs: ${renderError.message}</p>`;
      }

      // Pagination
      const totalPages = Math.ceil(total / currentLogsLimit);
      const currentPage = Math.floor(currentLogsOffset / currentLogsLimit) + 1;
      paginationEl.innerHTML = `
        <button type="button" ${currentPage === 1 ? 'disabled' : ''} onclick="currentLogsOffset = ${currentLogsOffset - currentLogsLimit}; loadLogs();">Previous</button>
        <span>Page ${currentPage} of ${totalPages} (${total} total)</span>
        <button type="button" ${currentPage >= totalPages ? 'disabled' : ''} onclick="currentLogsOffset = ${currentLogsOffset + currentLogsLimit}; loadLogs();">Next</button>
      `;
    }

    document.getElementById('refreshLogsBtn').addEventListener('click', () => {
      currentLogsOffset = 0;
      loadLogs();
    });

    document.getElementById('logTypeFilter').addEventListener('change', () => {
      currentLogsOffset = 0;
      loadLogs();
    });

    document.getElementById('statusFilter').addEventListener('change', () => {
      currentLogsOffset = 0;
      loadLogs();
    });

    document.getElementById('actionFilter').addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        currentLogsOffset = 0;
        loadLogs();
      }
    });

    (async () => {
      const ok = await checkAuth();
      if (ok) loadQueue('held');
    })();
  </script>
</body>
</html>
