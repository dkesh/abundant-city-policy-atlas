<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Abundant City Policy Atlas</title>
    <!-- Material Design Icons and Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <!-- Mapbox -->
    <script src="https://cdn.jsdelivr.net/npm/mapbox-gl@2.15.0/dist/mapbox-gl.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/mapbox-gl@2.15.0/dist/mapbox-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/supercluster@7.1.5/dist/supercluster.min.js"></script>
    <!-- Custom styles (includes compiled Material Design with density) -->
    <link rel="stylesheet" href="/styles.css">
    <style>
        /* Map-specific overrides */
        .container {
            max-width: 1400px;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .map-overlay {
            position: absolute;
            bottom: 40px;
            right: 10px;
            background: white;
            padding: 15px 20px;
            border-radius: 6px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }

        .map-overlay.active {
            display: block;
        }

        .map-overlay-header {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--color-light);
        }

        .map-overlay-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #7f8c8d;
        }

        /* Mapbox popup styling */
        .mapboxgl-popup-content {
            padding: 0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .popup-text {
            padding: 10px 15px;
            font-size: 14px;
            color: var(--color-text);
            cursor: pointer;
            background: white;
        }

        .popup-text:hover {
            background: var(--color-light);
        }

        @media (max-width: 768px) {
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="banner.svg" alt="The Abundant City Policy Atlas - Changing Cities By Design" class="banner-img">
            <div class="header-overlay">
                <a href="/about" class="about-link">About</a>
            </div>
            <!-- Hidden text for accessibility -->
            <div class="sr-only">
                <h1>The Abundant City Policy Atlas</h1>
                <p>Changing Cities By Design</p>
            </div>
        </header>

        <div class="main-content">
            <!-- SIDEBAR FILTERS -->
            <aside class="filters-panel">
                <h2 class="mdc-typography--headline6">Filters</h2>

                <!-- Policy Domain Filter (Multi-select Checkboxes) -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Policy Domain</div>
                    <div class="checkbox-group" id="reformTypeCheckboxes">
                        <!-- Populated by JavaScript from database -->
                    </div>
                </div>

                <!-- Jurisdiction Type Filter -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Jurisdiction Type</div>
                    <div class="checkbox-group">
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control placeTypeCheckbox" id="place-state" value="state">
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="place-state">States</label>
                        </div>
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control placeTypeCheckbox" id="place-county" value="county">
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="place-county">Counties</label>
                        </div>
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control placeTypeCheckbox" id="place-city" value="city" checked>
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="place-city">Cities</label>
                        </div>
                    </div>
                </div>

                <!-- Region/State Filter (Hierarchical) -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Location</div>
                    <div class="checkbox-group" id="locationCheckboxes">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Date Range Filter -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Adoption Date Range</div>
                    <div class="date-range-inputs">
                        <label class="mdc-text-field mdc-text-field--outlined mdc-text-field--no-label">
                            <span class="mdc-notched-outline">
                                <span class="mdc-notched-outline__leading"></span>
                                <span class="mdc-notched-outline__trailing"></span>
                            </span>
                            <input type="number" class="mdc-text-field__input" id="fromYear" placeholder="From" min="1900" max="2100">
                        </label>
                        <span class="date-range-separator">to</span>
                        <label class="mdc-text-field mdc-text-field--outlined mdc-text-field--no-label">
                            <span class="mdc-notched-outline">
                                <span class="mdc-notched-outline__leading"></span>
                                <span class="mdc-notched-outline__trailing"></span>
                            </span>
                            <input type="number" class="mdc-text-field__input" id="toYear" placeholder="To" min="1900" max="2100">
                        </label>
                    </div>
                    <div class="mdc-form-field date-checkbox-wrapper">
                        <div class="mdc-checkbox">
                            <input type="checkbox" class="mdc-checkbox__native-control" id="includeUnknownDates" checked>
                            <div class="mdc-checkbox__background">
                                <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                    <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                </svg>
                                <div class="mdc-checkbox__mixedmark"></div>
                            </div>
                            <div class="mdc-checkbox__ripple"></div>
                        </div>
                        <label for="includeUnknownDates">Include unknown dates</label>
                    </div>
                </div>

                <!-- Status Filter -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Reform Status</div>
                    <div class="checkbox-group">
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control statusCheckbox" id="status-adopted" value="adopted" checked>
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="status-adopted">Adopted</label>
                        </div>
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control statusCheckbox" id="status-proposed" value="proposed">
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="status-proposed">Proposed</label>
                        </div>
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control statusCheckbox" id="status-failed" value="failed">
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="status-failed">Failed</label>
                        </div>
                    </div>
                </div>

                <!-- Population Filter (Range Slider) -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Population Range</div>
                    <div id="populationSlider" class="mdc-slider mdc-slider--range" data-min="0" data-max="10000000">
                        <input class="mdc-slider__input" type="range" min="0" max="10000000" value="0" step="10000" name="populationMin" aria-label="Minimum population">
                        <input class="mdc-slider__input" type="range" min="0" max="10000000" value="10000000" step="10000" name="populationMax" aria-label="Maximum population">
                        <div class="mdc-slider__track">
                            <div class="mdc-slider__track--inactive"></div>
                            <div class="mdc-slider__track--active">
                                <div class="mdc-slider__track--active_fill"></div>
                            </div>
                        </div>
                        <div class="mdc-slider__thumb">
                            <div class="mdc-slider__thumb-knob"></div>
                        </div>
                        <div class="mdc-slider__thumb">
                            <div class="mdc-slider__thumb-knob"></div>
                        </div>
                    </div>
                    <div class="slider-values">
                        <span id="minPopulationLabel" class="mdc-typography--caption">0</span>
                        <span id="maxPopulationLabel" class="mdc-typography--caption">10,000,000</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="filter-buttons">
                    <button class="mdc-button mdc-button--raised" id="applyFilters">
                        <span class="mdc-button__ripple"></span>
                        <span class="mdc-button__label">Apply Filters</span>
                    </button>
                    <button class="mdc-button mdc-button--outlined" id="resetFilters">
                        <span class="mdc-button__ripple"></span>
                        <span class="mdc-button__label">Reset</span>
                    </button>
                    <button class="mdc-button mdc-button--outlined" id="shareSearch">
                        <span class="mdc-button__ripple"></span>
                        <i class="material-icons mdc-button__icon" aria-hidden="true">link</i>
                        <span class="mdc-button__label">Share</span>
                    </button>
                </div>
            </aside>

            <!-- MAIN CONTENT -->
            <div class="content-area">
                <!-- Error Banner -->
                <div id="errorMessage" class="mdc-banner mdc-banner--error container-hidden" role="banner">
                    <div class="mdc-banner__content" role="status" aria-live="assertive">
                        <div class="mdc-banner__text"></div>
                        <div class="mdc-banner__actions">
                            <button class="mdc-button mdc-banner__action" type="button" id="dismissError">
                                <span class="mdc-button__ripple"></span>
                                <span class="mdc-button__label">Dismiss</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Snackbar for toast notifications -->
                <div id="snackbar" class="mdc-snackbar" aria-live="assertive" aria-atomic="true" aria-hidden="true">
                    <div class="mdc-snackbar__surface">
                        <div class="mdc-snackbar__label" role="status" aria-atomic="true"></div>
                        <div class="mdc-snackbar__actions">
                            <button class="mdc-icon-button mdc-snackbar__action" type="button" aria-label="Close">
                                <i class="material-icons mdc-icon-button__icon">close</i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- View Tabs -->
                <div class="mdc-tab-bar" role="tablist">
                    <div class="mdc-tab-scroller">
                        <div class="mdc-tab-scroller__scroll-area">
                            <div class="mdc-tab-scroller__scroll-content">
                                <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true" tabindex="0" id="listViewTab">
                                    <span class="mdc-tab__content">
                                        <span class="mdc-tab__icon material-icons" aria-hidden="true">list</span>
                                        <span class="mdc-tab__text-label">List View</span>
                                    </span>
                                    <span class="mdc-tab-indicator mdc-tab-indicator--active">
                                        <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                    </span>
                                    <span class="mdc-tab__ripple"></span>
                                </button>
                                <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" id="mapViewTab">
                                    <span class="mdc-tab__content">
                                        <span class="mdc-tab__icon material-icons" aria-hidden="true">map</span>
                                        <span class="mdc-tab__text-label">Map View</span>
                                    </span>
                                    <span class="mdc-tab-indicator">
                                        <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                    </span>
                                    <span class="mdc-tab__ripple"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Info Banner -->
                <div id="resultsInfo" class="mdc-banner container-hidden" role="banner">
                    <div class="mdc-banner__content" role="status" aria-live="polite">
                        <div class="mdc-banner__text">
                            Found <strong id="resultCount">0</strong> reforms matching your filters
                        </div>
                        <div class="mdc-banner__actions">
                            <button class="mdc-icon-button mdc-banner__action" id="shareBannerBtn" title="Share this search">
                                <i class="material-icons mdc-icon-button__icon">link</i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="loading container-hidden">
                    <div class="mdc-circular-progress" style="width:48px;height:48px;" role="progressbar" aria-label="Loading reforms" aria-valuemin="0" aria-valuemax="1">
                        <div class="mdc-circular-progress__determinate-container">
                            <svg class="mdc-circular-progress__determinate-circle-graphic" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                <circle class="mdc-circular-progress__determinate-track" cx="24" cy="24" r="18" stroke-width="4"/>
                                <circle class="mdc-circular-progress__determinate-circle" cx="24" cy="24" r="18" stroke-dasharray="113.097" stroke-dashoffset="113.097" stroke-width="4"/>
                            </svg>
                        </div>
                        <div class="mdc-circular-progress__indeterminate-container">
                            <div class="mdc-circular-progress__spinner-layer">
                                <div class="mdc-circular-progress__circle-clipper mdc-circular-progress__circle-left">
                                    <svg class="mdc-circular-progress__indeterminate-circle-graphic" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="24" cy="24" r="18" stroke-dasharray="113.097" stroke-dashoffset="56.549" stroke-width="4"/>
                                    </svg>
                                </div>
                                <div class="mdc-circular-progress__gap-patch">
                                    <svg class="mdc-circular-progress__indeterminate-circle-graphic" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="24" cy="24" r="18" stroke-dasharray="113.097" stroke-dashoffset="56.549" stroke-width="3.2"/>
                                    </svg>
                                </div>
                                <div class="mdc-circular-progress__circle-clipper mdc-circular-progress__circle-right">
                                    <svg class="mdc-circular-progress__indeterminate-circle-graphic" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="24" cy="24" r="18" stroke-dasharray="113.097" stroke-dashoffset="56.549" stroke-width="4"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="mdc-typography--body1">Loading reforms...</p>
                </div>

                <!-- LIST VIEW -->
                <div id="listView" class="view-container active">
                    <div id="reformsList" class="reforms-list"></div>
                    <div id="noResultsList" class="no-results container-hidden">
                        <h3 class="mdc-typography--headline6">No Reforms Found</h3>
                        <p class="mdc-typography--body1">Try adjusting your filters to see more results.</p>
                    </div>
                </div>

                <!-- MAP VIEW -->
                <div id="mapView" class="view-container">
                    <div id="map"></div>
                    <div id="mapOverlay" class="map-overlay mdc-card">
                        <button class="mdc-icon-button map-overlay-close" id="closeOverlay">
                            <i class="material-icons mdc-icon-button__icon">close</i>
                        </button>
                        <div class="map-overlay-header mdc-typography--headline6" id="overlayHeader"></div>
                        <div id="overlayCards" class="reforms-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================

        let allReforms = [];
        let filteredReforms = [];
        let map = null;
        let mapMarkers = {};
        let clusterIndex = null;
        let reformsGeoJSON = [];
        const REGIONS = {
            'Northeast': ['Connecticut', 'Maine', 'Massachusetts', 'New Hampshire', 'Rhode Island', 'Vermont', 'New Jersey', 'New York', 'Pennsylvania'],
            'Midwest': ['Illinois', 'Indiana', 'Michigan', 'Ohio', 'Wisconsin', 'Iowa', 'Kansas', 'Minnesota', 'Missouri', 'Nebraska', 'North Dakota', 'South Dakota'],
            'South': ['Delaware', 'Florida', 'Georgia', 'Maryland', 'North Carolina', 'South Carolina', 'Virginia', 'West Virginia', 'Alabama', 'Kentucky', 'Mississippi', 'Tennessee', 'Arkansas', 'Louisiana', 'Oklahoma', 'Texas', 'District of Columbia'],
            'West': ['Arizona', 'Colorado', 'Idaho', 'Montana', 'Nevada', 'New Mexico', 'Utah', 'Wyoming', 'Alaska', 'California', 'Hawaii', 'Oregon', 'Washington']
        };

        // ============================================================================
        // UI ELEMENTS
        // ============================================================================

        const placeTypeCheckboxes = document.querySelectorAll('.placeTypeCheckbox');
        const statusCheckboxes = document.querySelectorAll('.statusCheckbox');
        const locationCheckboxes = document.getElementById('locationCheckboxes');
        const fromYear = document.getElementById('fromYear');
        const toYear = document.getElementById('toYear');
        const includeUnknownDates = document.getElementById('includeUnknownDates');
        const applyFiltersBtn = document.getElementById('applyFilters');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const reformsList = document.getElementById('reformsList');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsInfo = document.getElementById('resultsInfo');
        const resultCount = document.getElementById('resultCount');
        const noResultsList = document.getElementById('noResultsList');
        const errorMessage = document.getElementById('errorMessage');
        const dismissErrorBtn = document.getElementById('dismissError');
        const listViewTab = document.getElementById('listViewTab');
        const mapViewTab = document.getElementById('mapViewTab');
        const listView = document.getElementById('listView');
        const mapView = document.getElementById('mapView');
        const mapOverlay = document.getElementById('mapOverlay');
        const closeOverlayBtn = document.getElementById('closeOverlay');
        const minPopulationLabel = document.getElementById('minPopulationLabel');
        const maxPopulationLabel = document.getElementById('maxPopulationLabel');

        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================

        applyFiltersBtn.addEventListener('click', applyFilters);
        resetFiltersBtn.addEventListener('click', resetFilters);
        closeOverlayBtn.addEventListener('click', () => mapOverlay.classList.remove('active'));
        
        // Share Search button (combined save + share functionality)
        const shareSearchBtn = document.getElementById('shareSearch');
        shareSearchBtn.addEventListener('click', shareSearch);
        
        // Share button in results banner
        const shareBannerBtn = document.getElementById('shareBannerBtn');
        if (shareBannerBtn) {
            shareBannerBtn.addEventListener('click', shareSearch);
        }
        
        // Dismiss error button
        if (dismissErrorBtn) {
            dismissErrorBtn.addEventListener('click', hideError);
        }

        // ============================================================================
        // FUNCTIONS
        // ============================================================================

        // Helper functions for MDC slider
        function getSliderValues() {
            const slider = window.mdcComponents?.slider;
            if (slider) {
                return {
                    min: slider.getValueStart(),
                    max: slider.getValue()
                };
            }
            return { min: 0, max: 10000000 };
        }

        function setSliderValues(min, max) {
            const slider = window.mdcComponents?.slider;
            if (slider) {
                slider.setValueStart(min);
                slider.setValue(max);
            }
        }

        // ============================================================================
        // URL/FILTER CONVERSION UTILITIES
        // ============================================================================

        function getFilterConfig() {
            const reformTypes = getSelectedReformTypes();
            const placeTypes = getSelectedPlaceTypes();
            const statuses = getSelectedStatuses();
            const sliderValues = getSliderValues();
            const minPopulation = sliderValues.min;
            const maxPopulation = sliderValues.max;
            const states = getSelectedLocations();
            const fromYearVal = fromYear.value ? parseInt(fromYear.value) : null;
            const toYearVal = toYear.value ? parseInt(toYear.value) : null;
            const includeUnknown = includeUnknownDates.checked;

            return {
                reform_types: reformTypes,
                place_types: placeTypes,
                statuses: statuses,
                min_population: minPopulation > 0 ? minPopulation : null,
                max_population: maxPopulation < 10000000 ? maxPopulation : null,
                states: states,
                from_year: fromYearVal,
                to_year: toYearVal,
                include_unknown_dates: includeUnknown
            };
        }

        function filterConfigToUrlParams(config) {
            const params = new URLSearchParams();
            (config.reform_types || []).forEach(t => params.append('reform_type', t));
            (config.place_types || []).forEach(t => params.append('place_type', t));
            (config.statuses || []).forEach(s => params.append('status', s));
            if (config.min_population) params.append('min_population', config.min_population);
            if (config.max_population && config.max_population < 10000000) params.append('max_population', config.max_population);
            (config.states || []).forEach(s => params.append('state', s));
            if (config.from_year) params.append('from_year', config.from_year);
            if (config.to_year) params.append('to_year', config.to_year);
            if (config.include_unknown_dates) params.append('include_unknown_dates', 'true');
            return params;
        }

        function urlParamsToFilterConfig(urlSearchParams) {
            // Handle both URLSearchParams object and plain object
            const getMultiValue = (key) => {
                if (urlSearchParams instanceof URLSearchParams) {
                    return urlSearchParams.getAll(key);
                } else {
                    const val = urlSearchParams[key];
                    if (!val) return [];
                    if (Array.isArray(val)) return val.filter(Boolean);
                    return val.split(',').map(v => v.trim()).filter(Boolean);
                }
            };

            const getValue = (key) => {
                if (urlSearchParams instanceof URLSearchParams) {
                    return urlSearchParams.get(key);
                } else {
                    return urlSearchParams[key];
                }
            };

            return {
                reform_types: getMultiValue('reform_type'),
                place_types: getMultiValue('place_type'),
                statuses: getMultiValue('status'),
                min_population: getValue('min_population') ? parseInt(getValue('min_population')) : null,
                max_population: getValue('max_population') ? parseInt(getValue('max_population')) : null,
                states: getMultiValue('state'),
                from_year: getValue('from_year') ? parseInt(getValue('from_year')) : null,
                to_year: getValue('to_year') ? parseInt(getValue('to_year')) : null,
                include_unknown_dates: getValue('include_unknown_dates') === 'true'
            };
        }

        function applyFilterConfig(config) {
            // Apply reform types
            document.querySelectorAll('.reformTypeCheckbox').forEach(cb => {
                cb.checked = config.reform_types && config.reform_types.includes(cb.value);
            });
            // Update category checkboxes based on children
            document.querySelectorAll('.category-cb').forEach(cb => {
                const category = cb.dataset.category;
                const children = document.querySelectorAll(`.reformTypeCheckbox[data-category="${category}"]`);
                const allChecked = Array.from(children).every(child => child.checked);
                const someChecked = Array.from(children).some(child => child.checked);
                cb.checked = allChecked;
                cb.indeterminate = someChecked && !allChecked;
                // Sync MDC checkbox state
                const categoryMdcCheckbox = mdc.checkbox.MDCCheckbox.attachTo(cb.closest('.mdc-checkbox'));
                if (categoryMdcCheckbox) {
                    categoryMdcCheckbox.checked = allChecked;
                    categoryMdcCheckbox.indeterminate = someChecked && !allChecked;
                }
            });

            // Apply place types
            placeTypeCheckboxes.forEach(cb => {
                cb.checked = config.place_types && config.place_types.includes(cb.value);
            });

            // Apply statuses
            statusCheckboxes.forEach(cb => {
                cb.checked = config.statuses && config.statuses.includes(cb.value);
            });

            // Apply locations
            document.querySelectorAll('#locationCheckboxes input[type="checkbox"]').forEach(cb => {
                if (cb.dataset.state) {
                    cb.checked = config.states && config.states.includes(cb.dataset.state);
                    // Sync MDC checkbox state
                    const mdcCheckbox = mdc.checkbox.MDCCheckbox.attachTo(cb.closest('.mdc-checkbox'));
                    if (mdcCheckbox) {
                        mdcCheckbox.checked = cb.checked;
                    }
                }
            });
            // Update region checkboxes
            Object.keys(REGIONS).forEach(region => {
                const regionCheckbox = document.querySelector(`input[data-region="${region}"]:not([data-state])`);
                if (regionCheckbox) {
                    const stateCheckboxes = document.querySelectorAll(`input[data-state][data-region="${region}"]`);
                    const allChecked = Array.from(stateCheckboxes).every(cb => cb.checked);
                    const someChecked = Array.from(stateCheckboxes).some(cb => cb.checked);
                    regionCheckbox.checked = allChecked;
                    regionCheckbox.indeterminate = someChecked && !allChecked;
                    // Sync MDC checkbox state
                    const regionMdcCheckbox = mdc.checkbox.MDCCheckbox.attachTo(regionCheckbox.closest('.mdc-checkbox'));
                    if (regionMdcCheckbox) {
                        regionMdcCheckbox.checked = allChecked;
                        regionMdcCheckbox.indeterminate = someChecked && !allChecked;
                    }
                }
            });

            // Apply population
            setSliderValues(config.min_population || 0, config.max_population || 10000000);
            updatePopulationLabels();

            // Apply dates
            fromYear.value = config.from_year || '';
            toYear.value = config.to_year || '';
            includeUnknownDates.checked = config.include_unknown_dates !== false;
        }

        function updatePopulationLabels() {
            const sliderValues = getSliderValues();
            minPopulationLabel.textContent = sliderValues.min.toLocaleString();
            maxPopulationLabel.textContent = sliderValues.max.toLocaleString();
        }

        async function initializeReformTypeFilter() {
            try {
                const response = await fetch('/.netlify/functions/get-reform-types');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch reform types');
                }

                const container = document.getElementById('reformTypeCheckboxes');
                container.innerHTML = '';

                // Group Types by Category
                const byCategory = {};
                data.reformTypes.forEach(rt => {
                    const cat = rt.category || 'Other';
                    if (!byCategory[cat]) byCategory[cat] = [];
                    byCategory[cat].push(rt);
                });

                // Define order
                const catOrder = ['Parking', 'Housing Typology', 'Zoning Category', 'Physical Dimension', 'Process', 'Building Code', 'Other'];

                // Render Groups
                catOrder.forEach(cat => {
                    if (!byCategory[cat]) return;

                    // 1. Create Header (Chevron + MDC Checkbox + Label)
                    const catHeader = document.createElement('div');
                    catHeader.className = 'category-header'; // Reuses region-header style via CSS

                    // Chevron
                    const chevron = document.createElement('i');
                    chevron.className = 'material-icons chevron chevron-collapsed';
                    chevron.textContent = 'expand_more';
                    
                    // MDC form field wrapper
                    const categoryFormField = document.createElement('div');
                    categoryFormField.className = 'mdc-form-field category-group';
                    
                    // MDC Checkbox wrapper
                    const categoryCheckboxWrapper = document.createElement('div');
                    categoryCheckboxWrapper.className = 'mdc-checkbox';
                    
                    // Parent Checkbox
                    const parentCb = document.createElement('input');
                    parentCb.type = 'checkbox';
                    parentCb.className = 'mdc-checkbox__native-control category-cb';
                    parentCb.checked = true;
                    parentCb.id = `category-${cat}`;
                    parentCb.dataset.category = cat;
                    parentCb.addEventListener('change', (e) => updateReformHierarchy(e.target));
                    
                    const categoryBackground = document.createElement('div');
                    categoryBackground.className = 'mdc-checkbox__background';
                    categoryBackground.innerHTML = `
                        <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                            <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                        </svg>
                        <div class="mdc-checkbox__mixedmark"></div>
                    `;
                    
                    const categoryRipple = document.createElement('div');
                    categoryRipple.className = 'mdc-checkbox__ripple';
                    
                    categoryCheckboxWrapper.appendChild(parentCb);
                    categoryCheckboxWrapper.appendChild(categoryBackground);
                    categoryCheckboxWrapper.appendChild(categoryRipple);
                    
                    const categoryLabel = document.createElement('label');
                    categoryLabel.htmlFor = `category-${cat}`;
                    categoryLabel.textContent = cat;
                    
                    categoryFormField.appendChild(categoryCheckboxWrapper);
                    categoryFormField.appendChild(categoryLabel);

                    catHeader.appendChild(chevron);
                    catHeader.appendChild(categoryFormField);
                    container.appendChild(catHeader);
                    
                    // Initialize category MDC checkbox
                    const categoryMdcCheckbox = new mdc.checkbox.MDCCheckbox(categoryCheckboxWrapper);
                    const categoryMdcFormField = new mdc.formField.MDCFormField(categoryFormField);
                    categoryMdcFormField.input = categoryMdcCheckbox;

                    // 2. Create Reform Items Container (Hidden by default)
                    const reformsContainer = document.createElement('div');
                    reformsContainer.className = 'reforms-container container-hidden';

                    // Items
                    byCategory[cat].forEach(rt => {
                        const formField = document.createElement('div');
                        formField.className = 'mdc-form-field reform-item';
                        
                        // MDC Checkbox wrapper
                        const checkboxWrapper = document.createElement('div');
                        checkboxWrapper.className = 'mdc-checkbox';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'mdc-checkbox__native-control reformTypeCheckbox';
                        checkbox.value = rt.code;
                        checkbox.checked = true;
                        checkbox.id = `reform-${rt.code}`;
                        checkbox.dataset.category = cat;
                        checkbox.dataset.color = rt.color_hex;
                        checkbox.addEventListener('change', (e) => updateCategoryCheckbox(e.target));
                        
                        const background = document.createElement('div');
                        background.className = 'mdc-checkbox__background';
                        background.innerHTML = `
                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                            </svg>
                            <div class="mdc-checkbox__mixedmark"></div>
                        `;
                        
                        const ripple = document.createElement('div');
                        ripple.className = 'mdc-checkbox__ripple';
                        
                        checkboxWrapper.appendChild(checkbox);
                        checkboxWrapper.appendChild(background);
                        checkboxWrapper.appendChild(ripple);
                        
                        const label = document.createElement('label');
                        label.htmlFor = `reform-${rt.code}`;
                        label.textContent = rt.name;
                        
                        // Color indicator
                        if (rt.color_hex) {
                           formField.style.borderLeft = `3px solid ${rt.color_hex}`;
                           formField.style.paddingLeft = '8px';
                        }

                        formField.appendChild(checkboxWrapper);
                        formField.appendChild(label);
                        reformsContainer.appendChild(formField);
                        
                        // Initialize MDC checkbox
                        const mdcCheckbox = new mdc.checkbox.MDCCheckbox(checkboxWrapper);
                        const mdcFormField = new mdc.formField.MDCFormField(formField);
                        mdcFormField.input = mdcCheckbox;
                    });
                    
                    container.appendChild(reformsContainer);

                    // Toggle click handler
                    chevron.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isHidden = reformsContainer.classList.contains('container-hidden');
                        if (isHidden) {
                            reformsContainer.classList.remove('container-hidden');
                            reformsContainer.classList.add('reforms-container-visible');
                            chevron.classList.remove('chevron-collapsed');
                            chevron.classList.add('chevron-expanded');
                        } else {
                            reformsContainer.classList.add('container-hidden');
                            reformsContainer.classList.remove('reforms-container-visible');
                            chevron.classList.add('chevron-collapsed');
                            chevron.classList.remove('chevron-expanded');
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading reform types:', error);
                showError('Failed to load reform types');
            }
        }

        function getSelectedReformTypes() {
            const checkboxes = document.querySelectorAll('.reformTypeCheckbox');
            const selected = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selected.push(checkbox.value);
                }
            });
            return selected;
        }

        function getSelectedPlaceTypes() {
            const selected = [];
            placeTypeCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selected.push(checkbox.value);
                }
            });
            return selected;
        }

        function getSelectedStatuses() {
            const selected = [];
            statusCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selected.push(checkbox.value);
                }
            });
            return selected;
        }

        function getSelectedLocations() {
            const checkboxes = document.querySelectorAll('#locationCheckboxes input[data-state]:checked');
            const states = [];
            checkboxes.forEach(cb => {
                if (cb.dataset.state) {
                    states.push(cb.dataset.state);
                }
            });
            return states;
        }

        function updateLocationHierarchy(regionCheckbox) {
            const region = regionCheckbox.dataset.region;
            const states = REGIONS[region];
            const stateCheckboxes = document.querySelectorAll(
                `#locationCheckboxes input[data-state][data-region="${region}"]`
            );

            stateCheckboxes.forEach(cb => {
                cb.checked = regionCheckbox.checked;
                // Sync MDC checkbox state
                const mdcCheckbox = mdc.checkbox.MDCCheckbox.attachTo(cb.closest('.mdc-checkbox'));
                mdcCheckbox.checked = regionCheckbox.checked;
            });
        }

        function updateRegionCheckbox(stateCheckbox) {
            const region = stateCheckbox.dataset.region;
            const regionCheckbox = document.querySelector(
                `#locationCheckboxes input[data-region="${region}"]:not([data-state])`
            );

            if (!regionCheckbox) return;

            const stateCheckboxes = document.querySelectorAll(
                `#locationCheckboxes input[data-state][data-region="${region}"]`
            );
            const allChecked = Array.from(stateCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(stateCheckboxes).some(cb => cb.checked);

            regionCheckbox.checked = allChecked;
            regionCheckbox.indeterminate = someChecked && !allChecked;
            
            // Sync MDC checkbox state
            const regionMdcCheckbox = mdc.checkbox.MDCCheckbox.attachTo(regionCheckbox.closest('.mdc-checkbox'));
            regionMdcCheckbox.checked = allChecked;
            regionMdcCheckbox.indeterminate = someChecked && !allChecked;
        }

        // --- Reform Type Hierarchy Helpers ---

        function updateReformHierarchy(categoryCheckbox) {
            const category = categoryCheckbox.dataset.category;
            const reformCheckboxes = document.querySelectorAll(
                `.reformTypeCheckbox[data-category="${category}"]`
            );

            reformCheckboxes.forEach(cb => {
                cb.checked = categoryCheckbox.checked;
                // Sync MDC checkbox state
                const mdcCheckbox = mdc.checkbox.MDCCheckbox.attachTo(cb.closest('.mdc-checkbox'));
                if (mdcCheckbox) {
                    mdcCheckbox.checked = categoryCheckbox.checked;
                }
            });
        }

        function updateCategoryCheckbox(reformCheckbox) {
            const category = reformCheckbox.dataset.category;
            // Find parent category checkbox (it has data-category but NOT class 'reformTypeCheckbox' in my new design, 
            // or I can give it a specific class like 'category-cb')
            const categoryCheckbox = document.querySelector(
                `input.category-cb[data-category="${category}"]`
            );

            if (!categoryCheckbox) return;

            const siblings = document.querySelectorAll(
                `.reformTypeCheckbox[data-category="${category}"]`
            );
            const allChecked = Array.from(siblings).every(cb => cb.checked);
            const someChecked = Array.from(siblings).some(cb => cb.checked);

            categoryCheckbox.checked = allChecked;
            categoryCheckbox.indeterminate = someChecked && !allChecked;
            
            // Sync MDC checkbox state
            const categoryMdcCheckbox = mdc.checkbox.MDCCheckbox.attachTo(categoryCheckbox.closest('.mdc-checkbox'));
            if (categoryMdcCheckbox) {
                categoryMdcCheckbox.checked = allChecked;
                categoryMdcCheckbox.indeterminate = someChecked && !allChecked;
            }
        }

        function initializeLocationFilter() {
            locationCheckboxes.innerHTML = '';

            Object.keys(REGIONS).forEach(region => {
                // Region container
                const regionHeader = document.createElement('div');
                regionHeader.className = 'region-header';
                
                // Chevron toggle
                const chevron = document.createElement('i');
                chevron.className = 'material-icons chevron chevron-collapsed';
                chevron.textContent = 'expand_more';
                
                // Region MDC checkbox
                const regionFormField = document.createElement('div');
                regionFormField.className = 'mdc-form-field region-group';
                
                const regionCheckboxWrapper = document.createElement('div');
                regionCheckboxWrapper.className = 'mdc-checkbox';
                
                const regionCheckbox = document.createElement('input');
                regionCheckbox.type = 'checkbox';
                regionCheckbox.className = 'mdc-checkbox__native-control';
                regionCheckbox.id = `region-${region}`;
                regionCheckbox.dataset.region = region;
                regionCheckbox.addEventListener('change', (e) => updateLocationHierarchy(e.target));
                
                const regionBackground = document.createElement('div');
                regionBackground.className = 'mdc-checkbox__background';
                regionBackground.innerHTML = `
                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                    </svg>
                    <div class="mdc-checkbox__mixedmark"></div>
                `;
                
                const regionRipple = document.createElement('div');
                regionRipple.className = 'mdc-checkbox__ripple';
                
                regionCheckboxWrapper.appendChild(regionCheckbox);
                regionCheckboxWrapper.appendChild(regionBackground);
                regionCheckboxWrapper.appendChild(regionRipple);
                
                const regionLabel = document.createElement('label');
                regionLabel.htmlFor = `region-${region}`;
                regionLabel.textContent = region;
                
                regionFormField.appendChild(regionCheckboxWrapper);
                regionFormField.appendChild(regionLabel);
                
                // Header gets chevron + form field (chevron on left)
                regionHeader.appendChild(chevron);
                regionHeader.appendChild(regionFormField);
                locationCheckboxes.appendChild(regionHeader);

                // States container (hidden by default)
                const statesContainer = document.createElement('div');
                statesContainer.className = 'states-container container-hidden';

                REGIONS[region].forEach(state => {
                    const stateFormField = document.createElement('div');
                    stateFormField.className = 'mdc-form-field state-item';
                    
                    const stateCheckboxWrapper = document.createElement('div');
                    stateCheckboxWrapper.className = 'mdc-checkbox';
                    
                    const stateCheckbox = document.createElement('input');
                    stateCheckbox.type = 'checkbox';
                    stateCheckbox.className = 'mdc-checkbox__native-control';
                    stateCheckbox.id = `state-${state}`;
                    stateCheckbox.dataset.state = state;
                    stateCheckbox.dataset.region = region;
                    stateCheckbox.addEventListener('change', (e) => updateRegionCheckbox(e.target));
                    
                    const stateBackground = document.createElement('div');
                    stateBackground.className = 'mdc-checkbox__background';
                    stateBackground.innerHTML = `
                        <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                            <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                        </svg>
                        <div class="mdc-checkbox__mixedmark"></div>
                    `;
                    
                    const stateRipple = document.createElement('div');
                    stateRipple.className = 'mdc-checkbox__ripple';
                    
                    stateCheckboxWrapper.appendChild(stateCheckbox);
                    stateCheckboxWrapper.appendChild(stateBackground);
                    stateCheckboxWrapper.appendChild(stateRipple);
                    
                    const stateLabel = document.createElement('label');
                    stateLabel.htmlFor = `state-${state}`;
                    stateLabel.textContent = state;
                    
                    stateFormField.appendChild(stateCheckboxWrapper);
                    stateFormField.appendChild(stateLabel);
                    statesContainer.appendChild(stateFormField);
                    
                    // Initialize MDC checkbox
                    const mdcCheckbox = new mdc.checkbox.MDCCheckbox(stateCheckboxWrapper);
                    const mdcFormField = new mdc.formField.MDCFormField(stateFormField);
                    mdcFormField.input = mdcCheckbox;
                });
                
                locationCheckboxes.appendChild(statesContainer);
                
                // Initialize region checkbox
                const regionMdcCheckbox = new mdc.checkbox.MDCCheckbox(regionCheckboxWrapper);
                const regionMdcFormField = new mdc.formField.MDCFormField(regionFormField);
                regionMdcFormField.input = regionMdcCheckbox;

                // Toggle click handler
                chevron.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isHidden = statesContainer.classList.contains('container-hidden');
                    if (isHidden) {
                        statesContainer.classList.remove('container-hidden');
                        statesContainer.classList.add('states-container-visible');
                        chevron.classList.remove('chevron-collapsed');
                        chevron.classList.add('chevron-expanded');
                    } else {
                        statesContainer.classList.add('container-hidden');
                        statesContainer.classList.remove('states-container-visible');
                        chevron.classList.add('chevron-collapsed');
                        chevron.classList.remove('chevron-expanded');
                    }
                });
            });
        }

        async function applyFilters(skipUrlUpdate = false) {
            const reformTypes = getSelectedReformTypes();
            const placeTypes = getSelectedPlaceTypes();
            const statuses = getSelectedStatuses();
            const sliderValues = getSliderValues();
            const minPopulation = sliderValues.min;
            const maxPopulation = sliderValues.max;
            const states = getSelectedLocations();
            const fromYearVal = fromYear.value ? parseInt(fromYear.value) : null;
            const toYearVal = toYear.value ? parseInt(toYear.value) : null;
            const includeUnknown = includeUnknownDates.checked;

            showLoading(true);
            hideError();

            try {
                // Build query string
                const params = new URLSearchParams();
                reformTypes.forEach(t => params.append('reform_type', t));
                placeTypes.forEach(t => params.append('place_type', t));
                statuses.forEach(s => params.append('status', s));
                if (minPopulation > 0) params.append('min_population', minPopulation);
                if (maxPopulation < 10000000) params.append('max_population', maxPopulation);
                states.forEach(s => params.append('state', s));
                if (fromYearVal) params.append('from_year', fromYearVal);
                if (toYearVal) params.append('to_year', toYearVal);
                if (includeUnknown) params.append('include_unknown_dates', 'true');

                const query = params.toString();
                const url = query ? `/.netlify/functions/get-reforms?${query}` : '/.netlify/functions/get-reforms';

                // Update URL without reloading page
                if (!skipUrlUpdate) {
                    const newUrl = query 
                        ? `${window.location.pathname}?${query}` 
                        : window.location.pathname;
                    window.history.pushState({}, '', newUrl);
                }

                // Fetch reforms
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch reforms');
                }

                allReforms = data.reforms;
                filteredReforms = allReforms;

                renderReforms();
                showLoading(false);

                if (filteredReforms.length > 0) {
                    resultCount.textContent = filteredReforms.length;
                    resultsInfo.classList.remove('container-hidden');
                    const resultsBanner = window.mdcComponents?.resultsBanner;
                    if (resultsBanner) {
                        resultsBanner.open();
                    }
                    noResultsList.classList.add('container-hidden');
                } else {
                    const resultsBanner = window.mdcComponents?.resultsBanner;
                    if (resultsBanner) {
                        resultsBanner.close();
                    }
                    resultsInfo.classList.add('container-hidden');
                    noResultsList.classList.remove('container-hidden');
                }

            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
                showLoading(false);
                const resultsBanner = window.mdcComponents?.resultsBanner;
                if (resultsBanner) {
                    resultsBanner.close();
                }
                resultsInfo.classList.add('container-hidden');
                noResultsList.classList.remove('container-hidden');
            }
        }

        function resetFilters() {
            // Reset checkboxes
            document.querySelectorAll('.reformTypeCheckbox').forEach(cb => cb.checked = true);
            document.querySelectorAll('.category-cb').forEach(cb => {
                cb.checked = true;
                cb.indeterminate = false;
            });
            placeTypeCheckboxes.forEach(cb => {
                cb.checked = cb.value === 'city';
            });
            statusCheckboxes.forEach(cb => {
                cb.checked = cb.value === 'adopted';
            });
            document.querySelectorAll('#locationCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);

            // Reset sliders
            setSliderValues(0, 10000000);
            updatePopulationLabels();

            // Reset date range
            fromYear.value = '';
            toYear.value = '';
            includeUnknownDates.checked = true;

            // Clear URL params
            window.history.pushState({}, '', window.location.pathname);
            applyFilters(true);
        }

        // ============================================================================
        // SHARE SEARCH FUNCTION (combines save + share)
        // ============================================================================

        async function shareSearch() {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:830',message:'shareSearch called',data:{hasClipboard:!!navigator.clipboard,hasWriteText:!!(navigator.clipboard&&navigator.clipboard.writeText),isSecureContext:window.isSecureContext,hasFocus:document.hasFocus(),userAgent:navigator.userAgent.substring(0,50)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A,B,C'})}).catch(()=>{});
            // #endregion
            const filterConfig = getFilterConfig();
            
            // Prompt for optional title
            const title = prompt('Enter a name for this search (optional):');
            if (title === null) return; // User cancelled

            try {
                const response = await fetch('/.netlify/functions/save-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filter_config: filterConfig,
                        title: title || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Construct the full URL to copy - be very explicit
                    const shortId = data.saved_search.short_id;
                    const protocol = window.location.protocol;
                    const host = window.location.host;
                    const shortUrl = `${protocol}//${host}/saved/${shortId}`;
                    
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:856',message:'Before clipboard copy',data:{shortUrl:shortUrl,hasFocus:document.hasFocus(),isSecureContext:window.isSecureContext},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A,C'})}).catch(()=>{});
                    // #endregion
                    
                    // Update page title if a title was provided
                    if (title && title.trim()) {
                        document.title = `${title} - The Abundant City Policy Atlas`;
                    }
                    
                    // Update URL to the saved search URL
                    window.history.pushState({}, '', `/saved/${shortId}`);
                    
                    // Copy to clipboard - use the most reliable method
                    let copySuccess = false;
                    const textToCopy = shortUrl; // Store in variable to ensure we copy the right thing
                    
                    try {
                        // Try modern clipboard API first
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:872',message:'Attempting clipboard API',data:{hasFocus:document.hasFocus()},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A,B'})}).catch(()=>{});
                            // #endregion
                            await navigator.clipboard.writeText(textToCopy);
                            copySuccess = true;
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:874',message:'Clipboard API succeeded',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A,B'})}).catch(()=>{});
                            // #endregion
                        } else {
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:876',message:'Clipboard API not available',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
                            // #endregion
                            throw new Error('Clipboard API not available');
                        }
                    } catch (err) {
                        // #region agent log
                        fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:878',message:'Clipboard API failed',data:{errorName:err.name,errorMessage:err.message,errorStack:err.stack?err.stack.substring(0,200):null},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A,B,F'})}).catch(()=>{});
                        // #endregion
                        // Fallback: use textarea method
                        try {
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:880',message:'Attempting textarea fallback',data:{hasFocus:document.hasFocus(),activeElement:document.activeElement?document.activeElement.tagName:null},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C,D'})}).catch(()=>{});
                            // #endregion
                            const textArea = document.createElement('textarea');
                            textArea.value = textToCopy;
                            textArea.className = 'clipboard-textarea';
                            textArea.setAttribute('readonly', '');
                            document.body.appendChild(textArea);
                            
                            // Select the text
                            if (navigator.userAgent.match(/ipad|iphone/i)) {
                                // iOS specific
                                const range = document.createRange();
                                range.selectNodeContents(textArea);
                                const selection = window.getSelection();
                                selection.removeAllRanges();
                                selection.addRange(range);
                                textArea.setSelectionRange(0, 999999);
                            } else {
                                textArea.focus();
                                textArea.select();
                            }
                            
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:902',message:'Before execCommand copy',data:{hasFocus:document.hasFocus(),textAreaFocused:textArea===document.activeElement,selectionLength:window.getSelection().toString().length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C,D'})}).catch(()=>{});
                            // #endregion
                            
                            copySuccess = document.execCommand('copy');
                            
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:902',message:'execCommand result',data:{copySuccess:copySuccess},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C,D'})}).catch(()=>{});
                            // #endregion
                            
                            document.body.removeChild(textArea);
                        } catch (e) {
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:904',message:'Textarea fallback failed',data:{errorName:e.name,errorMessage:e.message,errorStack:e.stack?e.stack.substring(0,200):null},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D,F'})}).catch(()=>{});
                            // #endregion
                            console.error('Copy failed:', e);
                            copySuccess = false;
                        }
                    }
                    
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:910',message:'Final copy result',data:{copySuccess:copySuccess,textToCopy:textToCopy},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A,B,C,D,E,F'})}).catch(()=>{});
                    // #endregion
                    
                    if (copySuccess) {
                        showToast(`Link copied to clipboard! /saved/${shortId}`);
                    } else {
                        showToast(`Failed to copy. Please copy manually: ${shortUrl}`);
                    }
                } else {
                    showError(data.error || 'Failed to save search');
                }
            } catch (error) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/9614b917-70d0-4ce3-b80a-b7bdea1b71fe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:918',message:'Save search error',data:{errorName:error.name,errorMessage:error.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F'})}).catch(()=>{});
                // #endregion
                console.error('Error saving search:', error);
                showError('Failed to save search: ' + error.message);
            }
        }

        function showToast(message) {
            const snackbar = window.mdcComponents?.snackbar;
            if (snackbar) {
                snackbar.labelText = message;
                snackbar.timeoutMs = 4000;
                snackbar.open();
            } else {
                // Fallback if snackbar not initialized
                console.log('Toast:', message);
            }
        }

        function renderReforms() {
            reformsList.innerHTML = '';

            if (filteredReforms.length === 0) {
                return;
            }

            filteredReforms.forEach(reform => {
                const card = createReformCard(reform);
                reformsList.appendChild(card);
            });

            // Also render map if in map view
            if (mapView.classList.contains('active')) {
                renderMap();
            }
        }

        function createReformCard(reform, showDistance = false) {
            const card = document.createElement('div');
            card.className = `mdc-card reform-card ${reform.reform.type}`;

            const adoptionDate = reform.reform.adoption_date || 'Date unknown';
            const placeType = reform.place.type.charAt(0).toUpperCase() + reform.place.type.slice(1);

            const scopeTags = (reform.reform.scope || []).map(s =>
                `<span class="mdc-chip__text">${escapeHtml(s)}</span>`
            ).join('');

            const landUseTags = (reform.reform.land_use || []).map(l =>
                `<span class="mdc-chip__text">${escapeHtml(l)}</span>`
            ).join('');

            const requirementsTags = (reform.reform.requirements || []).map(r =>
                `<span class="mdc-chip__text">${escapeHtml(r)}</span>`
            ).join('');

            // Sources with logos only
            const reformLinkUrl = reform.reform.link_url || '';
            const sourcesHtml = (reform.reform.sources && reform.reform.sources.length > 0) ? 
                reform.reform.sources.map(source => {
                    const sourceUrl = reformLinkUrl || source.website_url || '';
                    const logoUrl = source.logo ? `${source.logo}` : '';
                    
                    if (!logoUrl) return '';
                    
                    if (sourceUrl) {
                        return `
                            <a href="${escapeHtml(sourceUrl)}" target="_blank" rel="noopener" class="source-logo-link">
                                <img src="${escapeHtml(logoUrl)}" alt="${escapeHtml(source.short_name)}" class="source-logo" />
                            </a>
                        `;
                    } else {
                        return `
                            <img src="${escapeHtml(logoUrl)}" alt="${escapeHtml(source.short_name)}" class="source-logo" />
                        `;
                    }
                }).join('')
            : '';

            card.innerHTML = `
                <div class="mdc-card__primary-action">
                    <div class="reform-header">
                        <h3 class="mdc-typography--headline6 reform-title">${reform.place.type === 'state' 
                            ? escapeHtml(reform.place.state) 
                            : `${escapeHtml(reform.place.name)}, ${escapeHtml(reform.place.state)}`}</h3>
                        <div class="reform-badges">
                            <span class="mdc-chip"><span class="mdc-chip__text">${escapeHtml(reform.reform.type_name)}</span></span>
                            <span class="mdc-chip"><span class="mdc-chip__text">${placeType}</span></span>
                            ${reform.place.region ? `<span class="mdc-chip"><span class="mdc-chip__text">${escapeHtml(reform.place.region)}</span></span>` : ''}
                        </div>
                    </div>

                    <div class="mdc-card__media-content reform-meta mdc-typography--body2">
                        <div class="meta-item">
                            <strong>Adopted:</strong> ${adoptionDate}
                        </div>
                        <div class="meta-item">
                            <strong>Status:</strong> ${escapeHtml(reform.reform.status || 'Adopted')}
                        </div>
                        ${reform.reform.policy_document && reform.reform.policy_document.title ? `
                        <div class="meta-item">
                            <strong>Bill Title:</strong> ${escapeHtml(reform.reform.policy_document.title)}
                        </div>
                        ` : ''}
                        ${reform.place.population ? `
                        <div class="meta-item">
                            <strong>Population:</strong> ${parseInt(reform.place.population).toLocaleString()}
                        </div>
                        ` : ''}
                    </div>

                    ${reform.reform.summary ? `
                    <div class="reform-summary mdc-typography--body2">
                        ${escapeHtml(reform.reform.summary)}
                    </div>
                    ` : ''}

                    <div class="reform-details">
                        ${reform.reform.scope.length > 0 ? `
                        <div class="detail-item">
                            <strong class="mdc-typography--subtitle2">Scope</strong>
                            <div class="tag-list">${scopeTags}</div>
                        </div>
                        ` : ''}
                        
                        ${reform.reform.land_use.length > 0 ? `
                        <div class="detail-item">
                            <strong class="mdc-typography--subtitle2">Land Use</strong>
                            <div class="tag-list">${landUseTags}</div>
                        </div>
                        ` : ''}

                        ${reform.reform.requirements.length > 0 ? `
                        <div class="detail-item">
                            <strong class="mdc-typography--subtitle2">Requirements</strong>
                            <div class="tag-list">${requirementsTags}</div>
                        </div>
                        ` : ''}
                    </div>

                    <div class="reform-footer">
                        <span class="mdc-typography--caption reform-footer-text">
                            ${reform.place.type.charAt(0).toUpperCase() + reform.place.type.slice(1)} ID: ${reform.id}
                        </span>
                        ${sourcesHtml ? `
                        <div class="sources-logos">
                            ${sourcesHtml}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            return card;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading(show) {
            const progress = window.mdcComponents?.circularProgress;
            if (show) {
                loadingSpinner.classList.remove('container-hidden');
                if (progress) {
                    progress.open();
                }
            } else {
                loadingSpinner.classList.add('container-hidden');
                if (progress) {
                    progress.close();
                }
            }
        }

        function showError(message) {
            const banner = window.mdcComponents?.errorBanner;
            if (banner && errorMessage) {
                const textEl = errorMessage.querySelector('.mdc-banner__text');
                if (textEl) {
                    textEl.textContent = message;
                }
                banner.open();
            } else if (errorMessage) {
                // Fallback if banner not initialized
                errorMessage.textContent = message;
                errorMessage.classList.remove('container-hidden');
            }
        }

        function hideError() {
            const banner = window.mdcComponents?.errorBanner;
            if (banner) {
                banner.close();
            } else if (errorMessage) {
                // Fallback if banner not initialized
                errorMessage.classList.add('container-hidden');
            }
        }

        function switchView(view) {
            if (view === 'list') {
                listView.classList.add('active');
                mapView.classList.remove('active');
                listViewTab.classList.add('active');
                mapViewTab.classList.remove('active');
            } else {
                listView.classList.remove('active');
                mapView.classList.add('active');
                listViewTab.classList.remove('active');
                mapViewTab.classList.add('active');
                initializeMap();
            }
        }

        function initializeMap() {
            if (map) return; // Already initialized

            // Note: Requires Mapbox GL token
            try {
                mapboxgl.accessToken = 'pk.eyJ1IjoiZGFua2VzaGV0IiwiYSI6ImNtazIwdzhpdTBiOWkzZXB3cjEwNmtlbzEifQ.CJh1ehe_-ZmT_SqZxBeL6g'; 
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/light-v11',
                    center: [-95.7129, 37.0902], // Center of US
                    zoom: 3.5
                });

                map.on('load', () => {
                    console.log('Map loaded successfully');
                    renderMap();
                });

                // Update markers when map is moved or zoomed
                map.on('moveend', () => {
                    updateMarkersInViewport();
                });
            } catch (e) {
                console.log('Mapbox GL not available. Showing list-only mode.');
                mapView.innerHTML = '<div class="map-error-message">Map view requires Mapbox GL. Please configure your Mapbox token in the code to enable this feature.</div>';
            }
        }

        function renderMap() {
            if (!map || !map.isStyleLoaded()) return;

            // Group reforms by place and create GeoJSON
            const placeReforms = {};
            reformsGeoJSON = [];
            
            filteredReforms.forEach(reform => {
                const placeKey = reform.place.id;
                if (!placeReforms[placeKey]) {
                    placeReforms[placeKey] = [];
                }
                placeReforms[placeKey].push(reform);
            });

            // Convert to GeoJSON features for clustering
            Object.entries(placeReforms).forEach(([placeId, reforms]) => {
                const place = reforms[0].place;
                if (place.latitude && place.longitude) {
                    reformsGeoJSON.push({
                        type: 'Feature',
                        properties: {
                            placeId: placeId,
                            reforms: reforms,
                            reformCount: reforms.length,
                            color: getMarkerColor(reforms[0].reform.type)
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: [place.longitude, place.latitude]
                        }
                    });
                }
            });

            // Initialize Supercluster
            clusterIndex = new Supercluster({
                radius: 60,
                maxZoom: 16,
                minZoom: 0,
                extent: 512,
                nodeSize: 64
            });
            
            clusterIndex.load(reformsGeoJSON);
            
            // Update markers for current viewport
            updateMarkersInViewport();
        }

        function updateMarkersInViewport() {
            if (!map || !clusterIndex) return;

            const bounds = map.getBounds();
            const zoom = map.getZoom();
            
            // Get clusters and points in current viewport
            const clusters = clusterIndex.getClusters(
                [bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth()],
                Math.floor(zoom)
            );

            // Clear existing markers
            Object.values(mapMarkers).forEach(marker => marker.remove());
            mapMarkers = {};

            // Add new markers
            clusters.forEach((cluster, idx) => {
                const [lng, lat] = cluster.geometry.coordinates;
                const props = cluster.properties;

                const el = document.createElement('div');
                el.className = 'marker marker-base';

                if (cluster.properties.cluster) {
                    // This is a cluster
                    const pointCount = cluster.properties.point_count;
                    let sizeClass = 'marker-cluster-small';
                    if (pointCount >= 50) {
                        sizeClass = 'marker-cluster-large';
                    } else if (pointCount >= 10) {
                        sizeClass = 'marker-cluster-medium';
                    }
                    
                    el.classList.add('marker-cluster', sizeClass);
                    el.textContent = pointCount;

                    // Zoom into cluster on click
                    el.addEventListener('click', () => {
                        const clusterId = cluster.id;
                        const zoom = clusterIndex.getClusterExpansionZoom(clusterId);
                        map.easeTo({
                            center: [lng, lat],
                            zoom: zoom
                        });
                    });
                } else {
                    // This is an individual place marker
                    el.classList.add('marker-place');
                    el.style.backgroundColor = props.color;

                    el.addEventListener('click', () => {
                        showPlaceOverlay(props.placeId, props.reforms);
                    });
                }

                const marker = new mapboxgl.Marker(el)
                    .setLngLat([lng, lat])
                    .addTo(map);

                mapMarkers[`marker-${idx}`] = marker;
            });
        }

        function getMarkerColor(reformType) {
            // Handle both prefixed (prn:rm_min) and non-prefixed (rm_min) types
            const type = reformType.includes(':') ? reformType.split(':')[1] : reformType;
            switch (type) {
                case 'rm_min': return '#27ae60';
                case 'reduce_min': return '#2ecc71';
                case 'add_max': return '#e74c3c';
                case 'adu': return '#3498db';
                case 'plex': return '#9b59b6';
                case 'tod': return '#f39c12';
                case 'other': return '#95a5a6';
                default: return '#3498db';
            }
        }

        function showPlaceOverlay(placeId, reforms) {
            const place = reforms[0].place;
            document.getElementById('overlayHeader').textContent = `${place.name}, ${place.state} (${reforms.length} reforms)`;
            
            const overlayCards = document.getElementById('overlayCards');
            overlayCards.innerHTML = '';
            reforms.forEach(reform => {
                overlayCards.appendChild(createReformCard(reform, true));
            });

            mapOverlay.classList.add('active');
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        async function loadFiltersFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.toString()) {
                const config = urlParamsToFilterConfig(urlParams);
                applyFilterConfig(config);
                return true;
            }
            return false;
        }

        async function loadSavedSearch() {
            const path = window.location.pathname;
            const savedMatch = path.match(/^\/saved\/([a-zA-Z0-9]+)$/);
            if (savedMatch) {
                const shortId = savedMatch[1];
                try {
                    const response = await fetch(`/.netlify/functions/get-saved-search?short_id=${shortId}`);
                    const data = await response.json();

                    if (data.success) {
                        const config = data.saved_search.filter_config;
                        applyFilterConfig(config);
                        
                        // Update page title if saved search has a title
                        if (data.saved_search.title) {
                            document.title = `${data.saved_search.title} - The Abundant City Policy Atlas`;
                        }
                        
                        // Show notification
                        showToast(`Loaded saved search: ${data.saved_search.title || 'Untitled'}`);
                        return true;
                    } else {
                        showError(data.error || 'Saved search not found');
                        // Redirect to home
                        window.history.replaceState({}, '', '/');
                    }
                } catch (error) {
                    console.error('Error loading saved search:', error);
                    showError('Failed to load saved search');
                    window.history.replaceState({}, '', '/');
                }
                return false;
            }
            return false;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize MDC components
            const mdcComponents = {
                buttons: [],
                checkboxes: [],
                textFields: [],
                slider: null,
                tabBar: null,
                iconButtons: [],
                circularProgress: null,
                snackbar: null,
                errorBanner: null,
                resultsBanner: null
            };

            // Initialize all buttons
            document.querySelectorAll('.mdc-button').forEach(button => {
                mdcComponents.buttons.push(new mdc.ripple.MDCRipple(button));
            });

            // Initialize all icon buttons
            document.querySelectorAll('.mdc-icon-button').forEach(iconButton => {
                const ripple = new mdc.ripple.MDCRipple(iconButton);
                ripple.unbounded = true;
                mdcComponents.iconButtons.push(ripple);
            });

            // Initialize all checkboxes
            document.querySelectorAll('.mdc-checkbox').forEach(checkbox => {
                mdcComponents.checkboxes.push(new mdc.checkbox.MDCCheckbox(checkbox));
            });

            // Initialize all form fields
            document.querySelectorAll('.mdc-form-field').forEach(formField => {
                new mdc.formField.MDCFormField(formField);
            });

            // Initialize text fields
            document.querySelectorAll('.mdc-text-field').forEach(textField => {
                mdcComponents.textFields.push(new mdc.textField.MDCTextField(textField));
            });

            // Initialize population slider
            const sliderEl = document.getElementById('populationSlider');
            if (sliderEl) {
                mdcComponents.slider = new mdc.slider.MDCSlider(sliderEl);
                
                // Listen for slider changes
                mdcComponents.slider.listen('MDCSlider:change', () => {
                    updatePopulationLabels();
                });
            }

            // Initialize tab bar
            const tabBarEl = document.querySelector('.mdc-tab-bar');
            if (tabBarEl) {
                mdcComponents.tabBar = new mdc.tabBar.MDCTabBar(tabBarEl);
                mdcComponents.tabBar.listen('MDCTabBar:activated', (e) => {
                    const view = e.detail.index === 0 ? 'list' : 'map';
                    switchView(view);
                });
            }

            // Initialize circular progress
            const progressEl = document.querySelector('.mdc-circular-progress');
            if (progressEl) {
                mdcComponents.circularProgress = new mdc.circularProgress.MDCCircularProgress(progressEl);
            }

            // Initialize snackbar
            const snackbarEl = document.getElementById('snackbar');
            if (snackbarEl) {
                mdcComponents.snackbar = new mdc.snackbar.MDCSnackbar(snackbarEl);
            }

            // Initialize error banner
            if (errorMessage) {
                mdcComponents.errorBanner = new mdc.banner.MDCBanner(errorMessage);
                // Initialize dismiss button ripple if it exists
                if (dismissErrorBtn) {
                    mdcComponents.buttons.push(new mdc.ripple.MDCRipple(dismissErrorBtn));
                }
            }

            // Initialize results banner
            const resultsBannerEl = document.getElementById('resultsInfo');
            if (resultsBannerEl) {
                mdcComponents.resultsBanner = new mdc.banner.MDCBanner(resultsBannerEl);
            }

            // Store MDC components globally for later access
            window.mdcComponents = mdcComponents;
            
            await initializeReformTypeFilter();
            initializeLocationFilter();
            updatePopulationLabels();
            
            // Try to load from saved search first, then URL params, then default
            const loadedSaved = await loadSavedSearch();
            if (!loadedSaved) {
                const loadedFromUrl = await loadFiltersFromUrl();
                if (!loadedFromUrl) {
                    // Apply default filters
                    applyFilters(true);
                } else {
                    // Load from URL params
                    applyFilters(true);
                }
            } else {
                // Loaded from saved search
                applyFilters(true);
            }
        });

        // Handle browser back/forward buttons
        window.addEventListener('popstate', async () => {
            const loadedFromUrl = await loadFiltersFromUrl();
            if (loadedFromUrl) {
                applyFilters(true);
            }
        });
    </script>
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
</body>
</html>
