<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Abundant City Policy Atlas</title>
    <!-- Material Design Icons and Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <!-- Mapbox -->
    <script src="https://cdn.jsdelivr.net/npm/mapbox-gl@2.15.0/dist/mapbox-gl.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/mapbox-gl@2.15.0/dist/mapbox-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/supercluster@7.1.5/dist/supercluster.min.js"></script>
    <!-- Material Components Web - Load before inline scripts -->
    <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
    <!-- Custom styles (includes compiled Material Design with density) -->
    <link rel="stylesheet" href="/styles.css">
    <!-- noUiSlider CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
    <style>
        /* Map-specific overrides */
        .container {
            max-width: 1400px;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .map-overlay {
            position: absolute;
            bottom: 40px;
            right: 10px;
            background: white;
            padding: 15px 20px;
            border-radius: 6px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }

        .map-overlay.active {
            display: block;
        }

        .map-overlay-header {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--color-light);
        }

        .map-overlay-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #7f8c8d;
        }

        /* Mapbox popup styling */
        .mapboxgl-popup-content {
            padding: 0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .popup-text {
            padding: 10px 15px;
            font-size: 14px;
            color: var(--color-text);
            cursor: pointer;
            background: white;
        }

        .popup-text:hover {
            background: var(--color-light);
        }

        @media (max-width: 768px) {
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="banner.svg" alt="The Abundant City Policy Atlas - Changing Cities By Design" class="banner-img">
            <div class="header-overlay">
                <a href="/about" class="about-link">About</a>
            </div>
            <!-- Hidden text for accessibility -->
            <div class="sr-only">
                <h1>The Abundant City Policy Atlas</h1>
                <p>Changing Cities By Design</p>
            </div>
        </header>

        <div class="main-content">
            <!-- SIDEBAR FILTERS -->
            <aside class="filters-panel">
                <h2 class="mdc-typography--headline6">Filters</h2>

                <!-- Policy Domain Filter (Multi-select Checkboxes) -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Policy Domain</div>
                    <div class="checkbox-group" id="reformTypeCheckboxes">
                        <!-- Populated by JavaScript from database -->
                    </div>
                </div>

                <!-- Level of Government Filter -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Level of Government</div>
                    <div class="checkbox-group">
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control placeTypeCheckbox" id="place-state" value="state">
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="place-state">State/Province/Territory</label>
                        </div>
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control placeTypeCheckbox" id="place-county" value="county">
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="place-county">Counties</label>
                        </div>
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control placeTypeCheckbox" id="place-city" value="city" checked>
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="place-city">Cities</label>
                        </div>
                    </div>
                </div>

                <!-- Region/State Filter (Hierarchical) -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Location</div>
                    <div class="checkbox-group" id="locationCheckboxes">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Date Range Filter -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Adoption Date Range</div>
                    <div class="date-range-inputs">
                        <label class="mdc-text-field mdc-text-field--outlined mdc-text-field--no-label">
                            <span class="mdc-notched-outline">
                                <span class="mdc-notched-outline__leading"></span>
                                <span class="mdc-notched-outline__trailing"></span>
                            </span>
                            <input type="number" class="mdc-text-field__input" id="fromYear" placeholder="From" min="1900" max="2100">
                        </label>
                        <span class="date-range-separator">to</span>
                        <label class="mdc-text-field mdc-text-field--outlined mdc-text-field--no-label">
                            <span class="mdc-notched-outline">
                                <span class="mdc-notched-outline__leading"></span>
                                <span class="mdc-notched-outline__trailing"></span>
                            </span>
                            <input type="number" class="mdc-text-field__input" id="toYear" placeholder="To" min="1900" max="2100">
                    </label>
                    </div>
                    <div class="mdc-form-field date-checkbox-wrapper">
                        <div class="mdc-checkbox">
                            <input type="checkbox" class="mdc-checkbox__native-control" id="includeUnknownDates" checked>
                            <div class="mdc-checkbox__background">
                                <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                    <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                </svg>
                                <div class="mdc-checkbox__mixedmark"></div>
                            </div>
                            <div class="mdc-checkbox__ripple"></div>
                        </div>
                        <label for="includeUnknownDates">Include unknown dates</label>
                    </div>
                </div>

                <!-- Status Filter -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Reform Status</div>
                    <div class="checkbox-group">
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control statusCheckbox" id="status-adopted" value="adopted" checked>
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="status-adopted">Adopted</label>
                        </div>
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control statusCheckbox" id="status-proposed" value="proposed">
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="status-proposed">Proposed</label>
                        </div>
                        <div class="mdc-form-field">
                            <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control statusCheckbox" id="status-failed" value="failed">
                                <div class="mdc-checkbox__background">
                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                    </svg>
                                    <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                            </div>
                            <label for="status-failed">Failed</label>
                        </div>
                    </div>
                </div>

                <!-- Population Filter (Range Slider) -->
                <div class="filter-group">
                    <div class="mdc-typography--subtitle2 filter-label">Population Range</div>
                    <div id="populationSlider" class="population-slider"></div>
                        <div class="slider-values">
                        <span id="populationRangeLabel" class="mdc-typography--caption">0 to 20,000,000</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="filter-buttons">
                    <button class="mdc-button mdc-button--raised" id="applyFilters">
                        <span class="mdc-button__ripple"></span>
                        <span class="mdc-button__label">Apply Filters</span>
                    </button>
                    <button class="mdc-button mdc-button--outlined" id="resetFilters">
                        <span class="mdc-button__ripple"></span>
                        <span class="mdc-button__label">Reset</span>
                    </button>
                    <button class="mdc-button mdc-button--outlined" id="shareSearch">
                        <span class="mdc-button__ripple"></span>
                        <i class="material-icons mdc-button__icon" aria-hidden="true">link</i>
                        <span class="mdc-button__label">Share</span>
                    </button>
                </div>
            </aside>

            <!-- MAIN CONTENT -->
            <div class="content-area">
                <!-- Error Banner -->
                <div id="errorMessage" class="mdc-banner mdc-banner--error container-hidden" role="banner">
                    <div class="mdc-banner__content" role="status" aria-live="assertive">
                        <div class="mdc-banner__text"></div>
                        <div class="mdc-banner__actions">
                            <button class="mdc-button mdc-banner__action" type="button" id="dismissError">
                                <span class="mdc-button__ripple"></span>
                                <span class="mdc-button__label">Dismiss</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Snackbar for toast notifications -->
                <div id="snackbar" class="mdc-snackbar" aria-live="assertive" aria-atomic="true" aria-hidden="true">
                    <div class="mdc-snackbar__surface">
                        <div class="mdc-snackbar__label" role="status" aria-atomic="true"></div>
                        <div class="mdc-snackbar__actions">
                            <button class="mdc-icon-button mdc-snackbar__action" type="button" aria-label="Close">
                                <i class="material-icons mdc-icon-button__icon">close</i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- View Tabs -->
                <div class="mdc-tab-bar" role="tablist">
                    <div class="mdc-tab-scroller">
                        <div class="mdc-tab-scroller__scroll-area">
                            <div class="mdc-tab-scroller__scroll-content">
                                <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true" tabindex="0" id="listViewTab">
                                    <span class="mdc-tab__content">
                                        <span class="mdc-tab__icon material-icons" aria-hidden="true">list</span>
                                        <span class="mdc-tab__text-label">List View</span>
                                    </span>
                                    <span class="mdc-tab-indicator mdc-tab-indicator--active">
                                        <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                    </span>
                                    <span class="mdc-tab__ripple"></span>
                                </button>
                                <button class="mdc-tab" role="tab" aria-selected="false" tabindex="-1" id="mapViewTab">
                                    <span class="mdc-tab__content">
                                        <span class="mdc-tab__icon material-icons" aria-hidden="true">map</span>
                                        <span class="mdc-tab__text-label">Map View</span>
                                    </span>
                                    <span class="mdc-tab-indicator">
                                        <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                    </span>
                                    <span class="mdc-tab__ripple"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Info Banner -->
                <div id="resultsInfo" class="mdc-banner container-hidden" role="banner">
                    <div class="mdc-banner__content" role="status" aria-live="polite">
                        <div class="mdc-banner__text">
                            Found <strong id="resultCount">0</strong> reforms matching your filters
                        </div>
                        <div class="mdc-banner__actions">
                            <button class="mdc-icon-button mdc-banner__action" id="shareBannerBtn" title="Share this search">
                                <i class="material-icons mdc-icon-button__icon">link</i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="loading container-hidden">
                    <div class="mdc-circular-progress" style="width:48px;height:48px;" role="progressbar" aria-label="Loading reforms" aria-valuemin="0" aria-valuemax="1">
                        <div class="mdc-circular-progress__determinate-container">
                            <svg class="mdc-circular-progress__determinate-circle-graphic" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                <circle class="mdc-circular-progress__determinate-track" cx="24" cy="24" r="18" stroke-width="4"/>
                                <circle class="mdc-circular-progress__determinate-circle" cx="24" cy="24" r="18" stroke-dasharray="113.097" stroke-dashoffset="113.097" stroke-width="4"/>
                            </svg>
                        </div>
                        <div class="mdc-circular-progress__indeterminate-container">
                            <div class="mdc-circular-progress__spinner-layer">
                                <div class="mdc-circular-progress__circle-clipper mdc-circular-progress__circle-left">
                                    <svg class="mdc-circular-progress__indeterminate-circle-graphic" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="24" cy="24" r="18" stroke-dasharray="113.097" stroke-dashoffset="56.549" stroke-width="4"/>
                                    </svg>
                                </div>
                                <div class="mdc-circular-progress__gap-patch">
                                    <svg class="mdc-circular-progress__indeterminate-circle-graphic" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="24" cy="24" r="18" stroke-dasharray="113.097" stroke-dashoffset="56.549" stroke-width="3.2"/>
                                    </svg>
                                </div>
                                <div class="mdc-circular-progress__circle-clipper mdc-circular-progress__circle-right">
                                    <svg class="mdc-circular-progress__indeterminate-circle-graphic" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="24" cy="24" r="18" stroke-dasharray="113.097" stroke-dashoffset="56.549" stroke-width="4"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="mdc-typography--body1">Loading reforms...</p>
                </div>

                <!-- LIST VIEW -->
                <div id="listView" class="view-container active">
                    <div id="reformsList" class="reforms-list"></div>
                    <div id="noResultsList" class="no-results container-hidden">
                        <h3 class="mdc-typography--headline6">No Reforms Found</h3>
                        <p class="mdc-typography--body1">Try adjusting your filters to see more results.</p>
                    </div>
                </div>

                <!-- MAP VIEW -->
                <div id="mapView" class="view-container">
                    <div id="map"></div>
                    <div id="mapOverlay" class="map-overlay mdc-card">
                        <button class="mdc-icon-button map-overlay-close" id="closeOverlay">
                            <i class="material-icons mdc-icon-button__icon">close</i>
                        </button>
                        <div class="map-overlay-header mdc-typography--headline6" id="overlayHeader"></div>
                        <div id="overlayCards" class="reforms-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- noUiSlider JS - must load before slider.js -->
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
    <!-- JavaScript modules - loaded in dependency order -->
    <script src="/js/state.js"></script>
    <script src="/js/ui-elements.js"></script>
    <script src="/js/slider.js"></script>
    <script src="/js/filters.js"></script>
    <script src="/js/filter-config.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/reforms.js"></script>
    <script src="/js/map.js"></script>
    <script src="/js/share.js"></script>
    <script src="/js/events.js"></script>
    <script src="/js/init.js"></script>
</body>
</html>
