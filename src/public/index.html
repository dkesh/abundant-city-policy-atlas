<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>National Urbanist Reform Map</title>
    <script src="https://cdn.jsdelivr.net/npm/mapbox-gl@2.15.0/dist/mapbox-gl.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/mapbox-gl@2.15.0/dist/mapbox-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/supercluster@7.1.5/dist/supercluster.min.js"></script>
    <style>
        :root {
            --color-primary: #2ecc71;
            --color-primary-dark: #27ae60;
            --color-secondary: #3498db;
            --color-danger: #e74c3c;
            --color-warning: #f39c12;
            --color-light: #ecf0f1;
            --color-dark: #2c3e50;
            --color-text: #34495e;
            --color-border: #bdc3c7;
            --color-bg: #fff;
            --rm-min: #27ae60;
            --reduce-min: #2ecc71;
            --add-max: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background-color: #f8f9fa;
            color: var(--color-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: white;
            padding: 40px 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        header p {
            font-size: 16px;
            opacity: 0.95;
        }

        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
        }

        /* ============ SIDEBAR FILTERS ============ */

        .filters-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            height: fit-content;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .filters-panel h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--color-dark);
            border-bottom: 2px solid var(--color-light);
            padding-bottom: 10px;
        }

        .filter-group {
            margin-bottom: 25px;
        }

        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 13px;
            text-transform: uppercase;
            color: var(--color-dark);
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            text-transform: none;
            letter-spacing: normal;
            margin-bottom: 0;
            cursor: pointer;
            font-size: 13px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            cursor: pointer;
            flex-shrink: 0;
        }

        /* Hierarchical checkboxes */
        .checkbox-group .region-group {
            margin-left: 0;
        }

        .checkbox-group .state-item {
            margin-left: 20px;
            display: flex;
        }

        /* Population slider */
        .slider-container {
            margin-top: 10px;
        }

        .range-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--color-light);
            outline: none;
            margin: 8px 0;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .range-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .slider-values {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 6px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background-color: var(--color-light);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background-color: #ddd;
        }

        /* ============ VIEW TABS ============ */

        .view-tabs {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            border-bottom: 2px solid var(--color-light);
        }

        .view-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            color: #7f8c8d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .view-tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        /* ============ MAIN CONTENT ============ */

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .results-info {
            background: white;
            padding: 15px 20px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .results-info p {
            margin: 0;
            font-size: 14px;
            color: var(--color-text);
        }

        .results-info strong {
            color: var(--color-primary);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--color-text);
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid var(--color-light);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============ LIST VIEW ============ */

        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
        }

        .reforms-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .reform-card {
            background: white;
            border-left: 4px solid var(--color-border);
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .reform-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .reform-card.rm_min {
            border-left-color: var(--rm-min);
        }

        .reform-card.reduce_min {
            border-left-color: var(--reduce-min);
        }

        .reform-card.add_max {
            border-left-color: var(--add-max);
        }

        .reform-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .reform-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-dark);
            margin: 0;
        }

        .reform-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-reform {
            background-color: var(--color-light);
            color: var(--color-dark);
        }

        .badge-type {
            background-color: var(--color-light);
            color: var(--color-dark);
        }

        .badge-region {
            background-color: var(--color-secondary);
            color: white;
        }

        .reform-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meta-item strong {
            color: var(--color-text);
        }

        .reform-summary {
            margin-bottom: 12px;
            line-height: 1.6;
            color: var(--color-text);
        }

        .reform-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 13px;
            border-top: 1px solid var(--color-light);
            padding-top: 12px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-item strong {
            color: var(--color-dark);
            margin-bottom: 4px;
        }

        .detail-item span {
            color: #7f8c8d;
        }

        .tag-list {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .tag {
            background-color: var(--color-light);
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            color: var(--color-text);
        }

        .reporter-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .prn-logo {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #333;
            color: white;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .reform-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--color-light);
            font-size: 12px;
        }

        .reform-link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: 600;
        }

        .reform-link:hover {
            text-decoration: underline;
        }

        /* ============ MAP VIEW ============ */

        #map {
            width: 100%;
            height: 600px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .map-overlay {
            position: absolute;
            bottom: 40px;
            right: 10px;
            background: white;
            padding: 15px 20px;
            border-radius: 6px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }

        .map-overlay.active {
            display: block;
        }

        .map-overlay-header {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--color-light);
        }

        .map-overlay-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #7f8c8d;
        }

        /* Mapbox popup styling */
        .mapboxgl-popup-content {
            padding: 0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .popup-text {
            padding: 10px 15px;
            font-size: 14px;
            color: var(--color-text);
            cursor: pointer;
            background: white;
        }

        .popup-text:hover {
            background: var(--color-light);
        }

        .no-results {
            background: white;
            padding: 40px;
            border-radius: 6px;
            text-align: center;
            color: #95a5a6;
        }

        .no-results h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .error-message {
            background-color: #ffe6e6;
            border: 1px solid var(--color-danger);
            color: var(--color-danger);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        /* ============ RESPONSIVE ============ */

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .filters-panel {
                position: static;
                max-height: none;
            }

            .reform-details {
                grid-template-columns: 1fr;
            }

            .reform-header {
                flex-direction: column;
            }

            .reform-badges {
                margin-top: 10px;
            }

            header h1 {
                font-size: 24px;
            }

            #map {
                height: 400px;
            }

            .view-tabs {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöó National Urbanist Reform Map</h1>
            <p>Explore parking minimums and maximum requirements across US cities, counties, and states</p>
        </header>

        <div class="main-content">
            <!-- SIDEBAR FILTERS -->
            <aside class="filters-panel">
                <h2>Filters</h2>

                <!-- Reform Type Filter (Multi-select Checkboxes) -->
                <div class="filter-group">
                    <label>Reform Types</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" class="reformTypeCheckbox" value="rm_min" checked> Parking mandates eliminated</label>
                        <label><input type="checkbox" class="reformTypeCheckbox" value="reduce_min" checked> Parking mandates reduced</label>
                        <label><input type="checkbox" class="reformTypeCheckbox" value="add_max" checked> Parking maximums</label>
                    </div>
                </div>

                <!-- Jurisdiction Type Filter -->
                <div class="filter-group">
                    <label>Jurisdiction Type</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" class="placeTypeCheckbox" value="state"> States</label>
                        <label><input type="checkbox" class="placeTypeCheckbox" value="county"> Counties</label>
                        <label><input type="checkbox" class="placeTypeCheckbox" value="city" checked> Cities</label>
                    </div>
                </div>

                <!-- Population Filter (Range Slider) -->
                <div class="filter-group">
                    <label>Population Range</label>
                    <div class="slider-container">
                        <input type="range" id="minPopulation" class="range-slider" min="0" max="10000000" value="0" step="10000">
                        <input type="range" id="maxPopulation" class="range-slider" min="0" max="10000000" value="10000000" step="10000">
                    </div>
                    <div class="slider-values">
                        <span id="minPopulationLabel">0</span>
                        <span id="maxPopulationLabel">10,000,000</span>
                    </div>
                </div>

                <!-- Region/State Filter (Hierarchical) -->
                <div class="filter-group">
                    <label>Location</label>
                    <div class="checkbox-group" id="locationCheckboxes">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="filter-buttons">
                    <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
                    <button class="btn btn-secondary" id="resetFilters">Reset</button>
                </div>
            </aside>

            <!-- MAIN CONTENT -->
            <div class="content-area">
                <div id="errorMessage" class="error-message" style="display: none;"></div>

                <!-- View Tabs -->
                <div class="view-tabs">
                    <button class="view-tab active" id="listViewTab">üìã List View</button>
                    <button class="view-tab" id="mapViewTab">üó∫Ô∏è Map View</button>
                </div>

                <!-- Results Info -->
                <div id="resultsInfo" class="results-info" style="display: none;">
                    <p>Found <strong id="resultCount">0</strong> reforms matching your filters</p>
                </div>

                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Loading reforms...</p>
                </div>

                <!-- LIST VIEW -->
                <div id="listView" class="view-container active">
                    <div id="reformsList" class="reforms-list"></div>
                    <div id="noResultsList" class="no-results" style="display: none;">
                        <h3>No Reforms Found</h3>
                        <p>Try adjusting your filters to see more results.</p>
                    </div>
                </div>

                <!-- MAP VIEW -->
                <div id="mapView" class="view-container">
                    <div id="map"></div>
                    <div id="mapOverlay" class="map-overlay">
                        <button class="map-overlay-close" id="closeOverlay">‚úï</button>
                        <div class="map-overlay-header" id="overlayHeader"></div>
                        <div id="overlayCards" class="reforms-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================

        let allReforms = [];
        let filteredReforms = [];
        let map = null;
        let mapMarkers = {};
        let clusterIndex = null;
        let reformsGeoJSON = [];
        const REGIONS = {
            'Northeast': ['Connecticut', 'Maine', 'Massachusetts', 'New Hampshire', 'Rhode Island', 'Vermont', 'New Jersey', 'New York', 'Pennsylvania'],
            'Midwest': ['Illinois', 'Indiana', 'Michigan', 'Ohio', 'Wisconsin', 'Iowa', 'Kansas', 'Minnesota', 'Missouri', 'Nebraska', 'North Dakota', 'South Dakota'],
            'South': ['Delaware', 'Florida', 'Georgia', 'Maryland', 'North Carolina', 'South Carolina', 'Virginia', 'West Virginia', 'Alabama', 'Kentucky', 'Mississippi', 'Tennessee', 'Arkansas', 'Louisiana', 'Oklahoma', 'Texas', 'District of Columbia'],
            'West': ['Arizona', 'Colorado', 'Idaho', 'Montana', 'Nevada', 'New Mexico', 'Utah', 'Wyoming', 'Alaska', 'California', 'Hawaii', 'Oregon', 'Washington']
        };

        // ============================================================================
        // UI ELEMENTS
        // ============================================================================

        const reformTypeCheckboxes = document.querySelectorAll('.reformTypeCheckbox');
        const placeTypeCheckboxes = document.querySelectorAll('.placeTypeCheckbox');
        const minPopulationSlider = document.getElementById('minPopulation');
        const maxPopulationSlider = document.getElementById('maxPopulation');
        const minPopulationLabel = document.getElementById('minPopulationLabel');
        const maxPopulationLabel = document.getElementById('maxPopulationLabel');
        const locationCheckboxes = document.getElementById('locationCheckboxes');
        const applyFiltersBtn = document.getElementById('applyFilters');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const reformsList = document.getElementById('reformsList');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsInfo = document.getElementById('resultsInfo');
        const resultCount = document.getElementById('resultCount');
        const noResultsList = document.getElementById('noResultsList');
        const errorMessage = document.getElementById('errorMessage');
        const listViewTab = document.getElementById('listViewTab');
        const mapViewTab = document.getElementById('mapViewTab');
        const listView = document.getElementById('listView');
        const mapView = document.getElementById('mapView');
        const mapOverlay = document.getElementById('mapOverlay');
        const closeOverlayBtn = document.getElementById('closeOverlay');

        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================

        applyFiltersBtn.addEventListener('click', applyFilters);
        resetFiltersBtn.addEventListener('click', resetFilters);
        listViewTab.addEventListener('click', () => switchView('list'));
        mapViewTab.addEventListener('click', () => switchView('map'));
        closeOverlayBtn.addEventListener('click', () => mapOverlay.classList.remove('active'));

        // Population slider synchronization
        minPopulationSlider.addEventListener('input', () => {
            if (parseInt(minPopulationSlider.value) > parseInt(maxPopulationSlider.value)) {
                maxPopulationSlider.value = minPopulationSlider.value;
            }
            updatePopulationLabels();
        });

        maxPopulationSlider.addEventListener('input', () => {
            if (parseInt(maxPopulationSlider.value) < parseInt(minPopulationSlider.value)) {
                minPopulationSlider.value = maxPopulationSlider.value;
            }
            updatePopulationLabels();
        });

        // ============================================================================
        // FUNCTIONS
        // ============================================================================

        function updatePopulationLabels() {
            const min = parseInt(minPopulationSlider.value);
            const max = parseInt(maxPopulationSlider.value);
            minPopulationLabel.textContent = min.toLocaleString();
            maxPopulationLabel.textContent = max.toLocaleString();
        }

        async function initializeReformTypeFilter() {
            try {
                const response = await fetch('/.netlify/functions/get-reform-types');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch reform types');
                }

                const container = document.querySelector('.filter-group .checkbox-group');
                container.innerHTML = '';

                data.reformTypes.forEach(rt => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'reformTypeCheckbox';
                    checkbox.value = rt.code;
                    checkbox.checked = true;
                    
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(' ' + rt.name));
                    container.appendChild(label);
                });
            } catch (error) {
                console.error('Error loading reform types:', error);
                showError('Failed to load reform types');
            }
        }

        function getSelectedReformTypes() {
            const checkboxes = document.querySelectorAll('.reformTypeCheckbox');
            const selected = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selected.push(checkbox.value);
                }
            });
            return selected;
        }

        function getSelectedPlaceTypes() {
            const selected = [];
            placeTypeCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selected.push(checkbox.value);
                }
            });
            return selected;
        }

        function getSelectedLocations() {
            const checkboxes = document.querySelectorAll('#locationCheckboxes input[data-state]:checked');
            const states = [];
            checkboxes.forEach(cb => {
                if (cb.dataset.state) {
                    states.push(cb.dataset.state);
                }
            });
            return states;
        }

        function updateLocationHierarchy(regionCheckbox) {
            const region = regionCheckbox.dataset.region;
            const states = REGIONS[region];
            const stateCheckboxes = document.querySelectorAll(
                `#locationCheckboxes input[data-state][data-region="${region}"]`
            );

            stateCheckboxes.forEach(cb => {
                cb.checked = regionCheckbox.checked;
            });
        }

        function updateRegionCheckbox(stateCheckbox) {
            const region = stateCheckbox.dataset.region;
            const regionCheckbox = document.querySelector(
                `#locationCheckboxes input[data-region="${region}"]:not([data-state])`
            );

            if (!regionCheckbox) return;

            const stateCheckboxes = document.querySelectorAll(
                `#locationCheckboxes input[data-state][data-region="${region}"]`
            );
            const allChecked = Array.from(stateCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(stateCheckboxes).some(cb => cb.checked);

            regionCheckbox.checked = allChecked;
            regionCheckbox.indeterminate = someChecked && !allChecked;
        }

        function initializeLocationFilter() {
            locationCheckboxes.innerHTML = '';

            Object.keys(REGIONS).forEach(region => {
                // Region checkbox
                const regionLabel = document.createElement('label');
                regionLabel.className = 'region-group';
                const regionCheckbox = document.createElement('input');
                regionCheckbox.type = 'checkbox';
                regionCheckbox.dataset.region = region;
                regionCheckbox.addEventListener('change', (e) => updateLocationHierarchy(e.target));
                regionLabel.appendChild(regionCheckbox);
                regionLabel.appendChild(document.createTextNode(region));
                locationCheckboxes.appendChild(regionLabel);

                // State checkboxes
                REGIONS[region].forEach(state => {
                    const stateLabel = document.createElement('label');
                    stateLabel.className = 'state-item';
                    const stateCheckbox = document.createElement('input');
                    stateCheckbox.type = 'checkbox';
                    stateCheckbox.dataset.state = state;
                    stateCheckbox.dataset.region = region;
                    stateCheckbox.addEventListener('change', (e) => updateRegionCheckbox(e.target));
                    stateLabel.appendChild(stateCheckbox);
                    stateLabel.appendChild(document.createTextNode(state));
                    locationCheckboxes.appendChild(stateLabel);
                });
            });
        }

        async function applyFilters() {
            const reformTypes = getSelectedReformTypes();
            const placeTypes = getSelectedPlaceTypes();
            const minPopulation = parseInt(minPopulationSlider.value);
            const maxPopulation = parseInt(maxPopulationSlider.value);
            const states = getSelectedLocations();

            showLoading(true);
            hideError();

            try {
                // Build query string
                const params = new URLSearchParams();
                reformTypes.forEach(t => params.append('reform_type', t));
                placeTypes.forEach(t => params.append('place_type', t));
                if (minPopulation > 0) params.append('min_population', minPopulation);
                if (maxPopulation < 10000000) params.append('max_population', maxPopulation);
                states.forEach(s => params.append('state', s));

                const query = params.toString();
                const url = query ? `/.netlify/functions/get-reforms?${query}` : '/.netlify/functions/get-reforms';

                // Fetch reforms
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch reforms');
                }

                allReforms = data.reforms;
                filteredReforms = allReforms;

                renderReforms();
                showLoading(false);

                if (filteredReforms.length > 0) {
                    resultsInfo.style.display = 'flex';
                    resultCount.textContent = filteredReforms.length;
                    noResultsList.style.display = 'none';
                } else {
                    resultsInfo.style.display = 'none';
                    noResultsList.style.display = 'block';
                }

            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
                showLoading(false);
                resultsInfo.style.display = 'none';
                noResultsList.style.display = 'block';
            }
        }

        function resetFilters() {
            // Reset checkboxes
            reformTypeCheckboxes.forEach(cb => cb.checked = true);
            placeTypeCheckboxes.forEach(cb => {
                cb.checked = cb.value === 'city';
            });
            document.querySelectorAll('#locationCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);

            // Reset sliders
            minPopulationSlider.value = 0;
            maxPopulationSlider.value = 10000000;
            updatePopulationLabels();

            applyFilters();
        }

        function renderReforms() {
            reformsList.innerHTML = '';

            if (filteredReforms.length === 0) {
                return;
            }

            filteredReforms.forEach(reform => {
                const card = createReformCard(reform);
                reformsList.appendChild(card);
            });

            // Also render map if in map view
            if (mapView.classList.contains('active')) {
                renderMap();
            }
        }

        function createReformCard(reform, showDistance = false) {
            const card = document.createElement('div');
            card.className = `reform-card ${reform.reform.type}`;

            const adoptionDate = reform.reform.adoption_date || 'Date unknown';
            const placeType = reform.place.type.charAt(0).toUpperCase() + reform.place.type.slice(1);

            const scopeTags = (reform.reform.scope || []).map(s =>
                `<div class="tag">${escapeHtml(s)}</div>`
            ).join('');

            const landUseTags = (reform.reform.land_use || []).map(l =>
                `<div class="tag">${escapeHtml(l)}</div>`
            ).join('');

            const requirementsTags = (reform.reform.requirements || []).map(r =>
                `<div class="tag">${escapeHtml(r)}</div>`
            ).join('');

            // Reporter with PRN logo
            const reporterHtml = reform.reform.reporter ? `
                <div class="reporter-info">
                    <span class="prn-logo" title="Parking Reform Network">PRN</span>
                    <span>${escapeHtml(reform.reform.reporter)}</span>
                </div>
            ` : '';

            card.innerHTML = `
                <div class="reform-header">
                    <h3 class="reform-title">${escapeHtml(reform.place.name)}, ${escapeHtml(reform.place.state)}</h3>
                    <div class="reform-badges">
                        <span class="badge badge-type">${escapeHtml(reform.reform.type_name)}</span>
                        <span class="badge badge-type">${placeType}</span>
                        ${reform.place.region ? `<span class="badge badge-region">${escapeHtml(reform.place.region)}</span>` : ''}
                    </div>
                </div>

                <div class="reform-meta">
                    <div class="meta-item">
                        <strong>Adopted:</strong> ${adoptionDate}
                    </div>
                    <div class="meta-item">
                        <strong>Status:</strong> ${escapeHtml(reform.reform.status || 'Adopted')}
                    </div>
                    ${reform.place.population ? `
                    <div class="meta-item">
                        <strong>Population:</strong> ${parseInt(reform.place.population).toLocaleString()}
                    </div>
                    ` : ''}
                </div>

                ${reform.reform.summary ? `
                <div class="reform-summary">
                    ${escapeHtml(reform.reform.summary)}
                </div>
                ` : ''}

                <div class="reform-details">
                    ${reform.reform.scope.length > 0 ? `
                    <div class="detail-item">
                        <strong>Scope</strong>
                        <div class="tag-list">${scopeTags}</div>
                    </div>
                    ` : ''}
                    
                    ${reform.reform.land_use.length > 0 ? `
                    <div class="detail-item">
                        <strong>Land Use</strong>
                        <div class="tag-list">${landUseTags}</div>
                    </div>
                    ` : ''}

                    ${reform.reform.requirements.length > 0 ? `
                    <div class="detail-item">
                        <strong>Requirements</strong>
                        <div class="tag-list">${requirementsTags}</div>
                    </div>
                    ` : ''}

                    ${reporterHtml ? `
                    <div class="detail-item">
                        <strong>Reporter</strong>
                        ${reporterHtml}
                    </div>
                    ` : ''}
                </div>

                <div class="reform-footer">
                    <span style="color: #95a5a6; font-size: 11px;">
                        ${reform.place.type.charAt(0).toUpperCase() + reform.place.type.slice(1)} ID: ${reform.id}
                    </span>
                    ${reform.reform.url ? `
                    <a href="${escapeHtml(reform.reform.url)}" target="_blank" rel="noopener" class="reform-link">
                        View Source ‚Üó
                    </a>
                    ` : ''}
                </div>
            `;

            return card;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading(show) {
            loadingSpinner.style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function switchView(view) {
            if (view === 'list') {
                listView.classList.add('active');
                mapView.classList.remove('active');
                listViewTab.classList.add('active');
                mapViewTab.classList.remove('active');
            } else {
                listView.classList.remove('active');
                mapView.classList.add('active');
                listViewTab.classList.remove('active');
                mapViewTab.classList.add('active');
                initializeMap();
            }
        }

        function initializeMap() {
            if (map) return; // Already initialized

            // Note: Requires Mapbox GL token
            try {
                mapboxgl.accessToken = 'pk.eyJ1IjoiZGFua2VzaGV0IiwiYSI6ImNtazIwdzhpdTBiOWkzZXB3cjEwNmtlbzEifQ.CJh1ehe_-ZmT_SqZxBeL6g'; 
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/light-v11',
                    center: [-95.7129, 37.0902], // Center of US
                    zoom: 3.5
                });

                map.on('load', () => {
                    console.log('Map loaded successfully');
                    renderMap();
                });

                // Update markers when map is moved or zoomed
                map.on('moveend', () => {
                    updateMarkersInViewport();
                });
            } catch (e) {
                console.log('Mapbox GL not available. Showing list-only mode.');
                mapView.innerHTML = '<div style="padding: 40px; text-align: center; color: #7f8c8d;">Map view requires Mapbox GL. Please configure your Mapbox token in the code to enable this feature.</div>';
            }
        }

        function renderMap() {
            if (!map || !map.isStyleLoaded()) return;

            // Group reforms by place and create GeoJSON
            const placeReforms = {};
            reformsGeoJSON = [];
            
            filteredReforms.forEach(reform => {
                const placeKey = reform.place.id;
                if (!placeReforms[placeKey]) {
                    placeReforms[placeKey] = [];
                }
                placeReforms[placeKey].push(reform);
            });

            // Convert to GeoJSON features for clustering
            Object.entries(placeReforms).forEach(([placeId, reforms]) => {
                const place = reforms[0].place;
                if (place.latitude && place.longitude) {
                    reformsGeoJSON.push({
                        type: 'Feature',
                        properties: {
                            placeId: placeId,
                            reforms: reforms,
                            reformCount: reforms.length,
                            color: getMarkerColor(reforms[0].reform.type)
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: [place.longitude, place.latitude]
                        }
                    });
                }
            });

            // Initialize Supercluster
            clusterIndex = new Supercluster({
                radius: 60,
                maxZoom: 16,
                minZoom: 0,
                extent: 512,
                nodeSize: 64
            });
            
            clusterIndex.load(reformsGeoJSON);
            
            // Update markers for current viewport
            updateMarkersInViewport();
        }

        function updateMarkersInViewport() {
            if (!map || !clusterIndex) return;

            const bounds = map.getBounds();
            const zoom = map.getZoom();
            
            // Get clusters and points in current viewport
            const clusters = clusterIndex.getClusters(
                [bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth()],
                Math.floor(zoom)
            );

            // Clear existing markers
            Object.values(mapMarkers).forEach(marker => marker.remove());
            mapMarkers = {};

            // Add new markers
            clusters.forEach((cluster, idx) => {
                const [lng, lat] = cluster.geometry.coordinates;
                const props = cluster.properties;

                const el = document.createElement('div');
                el.className = 'marker';
                el.style.cursor = 'pointer';
                el.style.border = '2px solid white';
                el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';

                if (cluster.properties.cluster) {
                    // This is a cluster
                    const pointCount = cluster.properties.point_count;
                    const size = pointCount < 10 ? 30 : pointCount < 50 ? 40 : 50;
                    
                    el.style.width = `${size}px`;
                    el.style.height = `${size}px`;
                    el.style.borderRadius = '50%';
                    el.style.backgroundColor = '#3498db';
                    el.style.display = 'flex';
                    el.style.alignItems = 'center';
                    el.style.justifyContent = 'center';
                    el.style.color = 'white';
                    el.style.fontWeight = 'bold';
                    el.style.fontSize = '12px';
                    el.textContent = pointCount;

                    // Zoom into cluster on click
                    el.addEventListener('click', () => {
                        const clusterId = cluster.id;
                        const zoom = clusterIndex.getClusterExpansionZoom(clusterId);
                        map.easeTo({
                            center: [lng, lat],
                            zoom: zoom
                        });
                    });
                } else {
                    // This is an individual place marker
                    el.style.backgroundColor = props.color;
                    el.style.width = '24px';
                    el.style.height = '24px';
                    el.style.borderRadius = '50%';

                    el.addEventListener('click', () => {
                        showPlaceOverlay(props.placeId, props.reforms);
                    });
                }

                const marker = new mapboxgl.Marker(el)
                    .setLngLat([lng, lat])
                    .addTo(map);

                mapMarkers[`marker-${idx}`] = marker;
            });
        }

        function getMarkerColor(reformType) {
            // Handle both prefixed (prn:rm_min) and non-prefixed (rm_min) types
            const type = reformType.includes(':') ? reformType.split(':')[1] : reformType;
            switch (type) {
                case 'rm_min': return '#27ae60';
                case 'reduce_min': return '#2ecc71';
                case 'add_max': return '#e74c3c';
                case 'adu': return '#3498db';
                case 'plex': return '#9b59b6';
                case 'tod': return '#f39c12';
                case 'other': return '#95a5a6';
                default: return '#3498db';
            }
        }

        function showPlaceOverlay(placeId, reforms) {
            const place = reforms[0].place;
            document.getElementById('overlayHeader').textContent = `${place.name}, ${place.state} (${reforms.length} reforms)`;
            
            const overlayCards = document.getElementById('overlayCards');
            overlayCards.innerHTML = '';
            reforms.forEach(reform => {
                overlayCards.appendChild(createReformCard(reform, true));
            });

            mapOverlay.classList.add('active');
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeReformTypeFilter();
            initializeLocationFilter();
            updatePopulationLabels();
            applyFilters(); // Load initial data
        });
    </script>
</body>
</html>
